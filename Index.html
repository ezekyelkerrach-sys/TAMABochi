<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <?!= include('CSS') ?>
  </head>
  <body>

    <!-- ============================================ -->
    <!--                   LOADER                     -->
    <!-- ============================================ -->
    <div id="loader" class="loading">
      <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
    </div>

    <!-- ============================================ -->
    <!--                ECRAN LOGIN                   -->
    <!-- ============================================ -->
    <div id="login-screen">
      <div class="card shadow p-5" style="width: 450px;">
        <div class="text-center mb-5">
          <h2 class="fw-bold text-primary">TAMABochi</h2>
          <p class="text-muted">Utopia 56 Grande-Synthe</p>
        </div>
        <div class="mb-3">
          <label class="fw-bold small">Identifiant</label>
          <input type="email" id="login-email" class="form-control form-control-lg">
        </div>
        <div class="mb-4">
          <label class="fw-bold small">Mot de passe</label>
          <input type="password" id="login-pass" class="form-control form-control-lg">
        </div>
        <button onclick="attemptLogin()" class="btn btn-primary w-100 py-3 fw-bold">Se connecter</button>
        <div id="login-error" class="text-danger mt-3 text-center small"></div>
      </div>
    </div>

    <!-- ============================================ -->
    <!--              CONTENU APPLICATION             -->
    <!-- ============================================ -->
    <div id="app-content" class="container-fluid" style="display:none !important;">
      <div class="row">

        <!-- ========== SIDEBAR ========== -->
        <div class="col-12 col-md-2 sidebar p-4">
          <h4 class="mb-4 text-center fw-bold">TAMABochi</h4>
          <div id="user-display" class="mb-4 text-center text-light small fw-bold bg-white bg-opacity-10 p-2 rounded"></div>
          <ul class="nav flex-column">
            <li class="nav-item"><a class="nav-link active" onclick="navigate('dashboard')"><i class="fas fa-home me-3"></i>Tableau de bord</a></li>
            <li class="nav-item"><a class="nav-link" onclick="navigate('suivi')"><i class="fas fa-search me-3"></i>Suivi & Recherche</a></li>
            <li class="nav-item"><a class="nav-link" onclick="navigate('enregistrement')"><i class="fas fa-user-plus me-3"></i>Enregistrement</a></li>
            <li class="nav-item"><a class="nav-link" onclick="navigate('plaidoyer')"><i class="fas fa-chart-pie me-3"></i>Plaidoyer</a></li>
            <!-- U7 : Badge compteur rappels en retard -->
            <li class="nav-item"><a class="nav-link" onclick="navigate('rappels')"><i class="fas fa-bell me-3"></i>Rappels<span id="sidebar-rappel-badge" class="nav-badge-count d-none">0</span></a></li>
            <hr class="my-4 border-light">
            <li class="nav-item"><a class="nav-link text-danger" onclick="logout()"><i class="fas fa-sign-out-alt me-3"></i>Déconnexion</a></li>
          </ul>
        </div>

        <!-- ========== CONTENU PRINCIPAL ========== -->
        <div class="col-12 col-md-10 p-5" style="height: 100vh; overflow-y: auto;">
          
          <!-- ============================================ -->
          <!--              VUE DASHBOARD                   -->
          <!-- ============================================ -->
          <div id="view-dashboard" class="content-view">
            <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
              <h2 class="fw-bold mb-0">Tableau de bord</h2>
              <div class="d-flex gap-2">
                <button class="btn btn-sm btn-outline-primary" onclick="openAddDashWidgetModal()"><i class="fas fa-plus me-1"></i> Ajouter un widget</button>
                <button class="btn btn-sm btn-outline-primary layout-toggle-btn" id="btn-dash-layout-mode" onclick="toggleDashLayoutMode()"><i class="fas fa-th me-1"></i> Disposer</button>
                <button class="btn btn-sm btn-outline-secondary" onclick="refreshDashboardWidgets()"><i class="fas fa-sync me-1"></i></button>
              </div>
            </div>

            <div id="dashboard-widgets-grid" class="dashboard-widgets-grid">
              <div class="dash-empty-state" id="dash-widgets-empty">
                <i class="fas fa-puzzle-piece fa-3x mb-3 text-primary"></i>
                <p class="text-muted">Personnalisez votre tableau de bord en ajoutant des widgets.</p>
                <button class="btn btn-sm btn-primary text-white" onclick="openAddDashWidgetModal()"><i class="fas fa-plus me-1"></i> Ajouter un widget</button>
                <button class="btn btn-sm btn-outline-secondary ms-2" onclick="loadDefaultDashWidgets()"><i class="fas fa-magic me-1"></i> Config par défaut</button>
              </div>
            </div>
          </div>

          <!-- ============================================ -->
          <!--           VUE SUIVI & RECHERCHE              -->
          <!-- ============================================ -->
          <div id="view-suivi" class="content-view d-none">
            <h2 class="fw-bold mb-4"><i class="fas fa-users text-primary me-2"></i>Suivi & Recherche</h2>
            
            <!-- Barre de recherche -->
            <div class="card p-4 mb-3">
              <div class="input-group input-group-lg">
                <input type="text" class="form-control border-0 bg-light" id="search-input" placeholder="Rechercher par Nom, Tel ou Lieu de vie...">
                <button class="btn btn-primary px-4" type="button" onclick="lancerRecherche()"><i class="fas fa-search"></i></button>
              </div>
              <!-- C12 / M5 : Boutons Tous les actifs + Tous les jeunes -->
              <div class="mt-2 d-flex gap-2 flex-wrap">
                <button class="btn btn-sm btn-outline-dark" onclick="afficherTousActifs()"><i class="fas fa-users me-1"></i> Tous les actifs</button>
                <button class="btn btn-sm btn-outline-secondary" onclick="afficherTousJeunes()"><i class="fas fa-database me-1"></i> Tous les jeunes</button>
                <!-- C6 : Bouton Éviction rapide -->
                <button class="btn btn-sm btn-eviction" onclick="openEvictionModal()"><i class="fas fa-house-chimney-crack me-1"></i> Éviction par lieu</button>
              </div>
            </div>

            <!-- C11 : Barre de filtres avancés (M6 : custom dropdowns) -->
            <div class="filter-bar card p-3 mb-3">
              <div class="row g-2 align-items-end">
                <div class="col-md-3">
                  <label class="form-label">Statut Présence</label>
                  <div id="filter-presence" class="custom-dropdown" data-config="STATUT_PRESENCE" data-mode="single" data-placeholder="Tous"></div>
                </div>
                <div class="col-md-3">
                  <label class="form-label">Statut MAB</label>
                  <div id="filter-mab" class="custom-dropdown" data-config="STATUTS_MAB" data-mode="single" data-placeholder="Tous"></div>
                </div>
                <div class="col-md-3">
                  <label class="form-label">Vulnérabilité</label>
                  <div id="filter-vuln" class="custom-dropdown" data-config="VULNERABILITES_TAGS" data-mode="single" data-placeholder="Toutes"></div>
                </div>
                <div class="col-md-2">
                  <label class="form-label">Lieu de Vie</label>
                  <div id="filter-lieu" class="custom-dropdown" data-config="LIEUX_VIE" data-mode="single" data-placeholder="Tous"></div>
                </div>
                <div class="col-md-1">
                  <button class="btn btn-sm btn-outline-secondary w-100 btn-filter-reset" onclick="resetFilters()"><i class="fas fa-times"></i></button>
                </div>
              </div>
            </div>

            <!-- U9 : Barre de tri + compteur résultats -->
            <div class="sort-bar d-none" id="sort-bar">
              <span class="result-count" id="result-count">0 résultats</span>
              <select class="form-select form-select-sm" id="sort-select" onchange="trierResultats()">
                <option value="nom-asc">Nom (A-Z)</option>
                <option value="nom-desc">Nom (Z-A)</option>
                <option value="age-asc">Âge (croissant)</option>
                <option value="age-desc">Âge (décroissant)</option>
                <option value="date-desc">Dernier contact (récent)</option>
                <option value="date-asc">Dernier contact (ancien)</option>
                <option value="lieu-asc">Lieu de vie (A-Z)</option>
              </select>
            </div>

            <div id="search-results-container" class="row g-3">
              <div class="col-12 text-center text-muted py-5">
                <i class="fas fa-inbox fa-3x mb-3"></i>
                <p>Les résultats s'afficheront ici.</p>
              </div>
            </div>
          </div>

          <!-- ============================================ -->
          <!--            VUE ENREGISTREMENT                -->
          <!-- ============================================ -->
          <div id="view-enregistrement" class="content-view d-none">
            <h2 class="fw-bold mb-4"><i class="fas fa-user-plus text-primary me-2"></i>Nouveau Jeune</h2>
            <div class="row">
              <div class="col-lg-9">
                <div class="card p-4">
                  <form id="form-creation" onsubmit="event.preventDefault(); return false;">
                    <input type="hidden" id="current-group-id" value="">
                    <!-- NOUVEAU : ID groupe lié via recherche (sans tel partagé) -->
                    <input type="hidden" id="linked-group-id" value="">
                    
                    <h5 class="text-primary fw-bold mb-3">Identité</h5>
                    <div class="row mb-3">
                      <div class="col-md-6">
                        <label class="form-label">Téléphone</label>
                        <input type="text" class="form-control" id="new-tel" onchange="verifierDoublon(this.value)">
                        <div id="alert-doublon" class="form-text text-danger fw-bold"></div>
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">Nom / Alias *</label>
                        <input type="text" class="form-control" id="new-nom" required>
                      </div>
                    </div>
                    <div class="row mb-3">
                      <div class="col-md-4">
                        <label class="form-label">Surnom</label>
                        <input type="text" class="form-control" id="new-surnom">
                      </div>
                      <div class="col-md-4">
                        <label class="form-label">Age</label>
                        <input type="number" class="form-control" id="new-age">
                      </div>
                      <div class="col-md-4">
                        <label class="form-label">Genre</label>
                        <div id="new-genre" class="custom-dropdown" data-config="GENRE" data-mode="single" data-placeholder="Sélectionner..."></div>
                      </div>
                    </div>
                    <div class="row mb-3">
                      <div class="col-md-4">
                        <label class="form-label fw-bold">Lieu de Vie (Actuel)</label>
                        <div id="new-lieuvie" class="custom-dropdown" data-config="LIEUX_VIE" data-mode="single" data-placeholder="Sélectionner..."></div>
                      </div>
                      <div class="col-md-4">
                        <label class="form-label">Nationalité</label>
                        <div id="new-nationalite" class="custom-dropdown" data-config="NATIONALITES" data-mode="single" data-placeholder="Sélectionner..."></div>
                      </div>
                      <div class="col-md-4">
                        <label class="form-label">Langue(s)</label>
                        <div id="new-langue" class="custom-dropdown" data-config="LANGUES" data-mode="multi" data-placeholder="Sélectionner..."></div>
                      </div>
                    </div>
                    
                    <!-- NOUVEAU : Liaison groupe sans téléphone partagé -->
                    <div class="mb-3 p-3 bg-light rounded border">
                      <div class="form-check form-switch mb-2">
                        <input class="form-check-input" type="checkbox" id="new-link-group-check" onchange="toggleLinkGroupSection()">
                        <label class="form-check-label fw-bold" for="new-link-group-check">
                          <i class="fas fa-link me-1"></i> Lier à un groupe avec téléphone différent
                        </label>
                      </div>
                      <div id="new-link-group-section" class="d-none mt-2">
                        <p class="text-muted small mb-2">Recherchez et sélectionnez les jeunes à lier à ce nouveau jeune (groupe commun, sans partager le même numéro).</p>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="openGroupLinkModal('enregistrement')">
                          <i class="fas fa-search me-1"></i> Rechercher des jeunes à lier
                        </button>
                        <div id="new-link-group-selected" class="mt-2 d-flex flex-wrap gap-1">
                          <!-- Badges des jeunes sélectionnés apparaîtront ici -->
                        </div>
                      </div>
                    </div>

                    <div class="mb-3">
                      <label class="form-label text-warning fw-bold"><i class="fas fa-sticky-note me-1"></i> Infos Importantes / Note Fixe</label>
                      <textarea class="form-control" id="new-notes-fixes" rows="1" placeholder="Ex: Lit l'allemand, Avec son frère majeur..."></textarea>
                    </div>

                    <div class="mb-3">
                      <label class="form-label text-primary fw-bold">Labels / Autres Assos</label>
                      <div id="new-labels" class="custom-dropdown" data-config="LABELS_CONTACTS_AUTRES" data-mode="multi" data-placeholder="Sélectionner..."></div>
                    </div>

                    <hr>
                    <h5 class="text-primary fw-bold mb-3">Contexte de la Rencontre</h5>
                    <div class="alert alert-info py-2 small">
                      <i class="fas fa-info-circle"></i> Cet enregistrement créera automatiquement un événement <strong>"Rencontre"</strong>.
                    </div>
                    <div class="row mb-3">
                      <div class="col-md-6">
                        <label class="form-label">Date Rencontre</label>
                        <input type="date" class="form-control" id="new-date-rencontre">
                      </div>
                      <div class="col-md-6">
                        <label class="form-label fw-bold text-success">Type de Contact</label>
                        <div id="new-type-contact" class="custom-dropdown" data-config="TYPES_CONTACT" data-mode="multi" data-placeholder="Sélectionner..."></div>
                      </div>
                    </div>
                    <div class="mb-3">
                      <label class="form-label fw-bold">Vulnérabilités</label>
                      <div id="new-vulns" class="custom-dropdown" data-config="VULNERABILITES_TAGS" data-mode="multi" data-placeholder="Sélectionner..."></div>
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Notes</label>
                      <textarea class="form-control" id="new-details" rows="2"></textarea>
                    </div>

                    <!-- M2 : Suppression du bloc "Événements Antérieurs" -->
                    <!-- M3 : Enregistrer + Ajouter Autre conserve le tel et le groupId -->
                    <!-- M2 : Enregistrer & Terminer redirige vers la fiche -->
                    <div class="row g-2 mt-3">
                      <div class="col-md-6">
                        <button type="button" class="btn btn-outline-success w-100" onclick="soumettreNouveauJeune(null, true, false)"><i class="fas fa-user-plus me-1"></i> Enregistrer & Ajouter Autre</button>
                      </div>
                      <div class="col-md-6">
                        <button type="button" class="btn btn-success w-100" onclick="soumettreNouveauJeune(null, false, true)"><i class="fas fa-check me-1"></i> Enregistrer & Accéder à la fiche</button>
                      </div>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>
          
          <!-- ============================================ -->
          <!--          VUE PLAIDOYER & STATS               -->
          <!-- ============================================ -->
          <!-- ============================================ -->
          <!--          VUE PLAIDOYER & STATS (PHASE 3)     -->
          <!-- ============================================ -->
          <div id="view-plaidoyer" class="content-view d-none">

            <!-- BARRE SUPERIEURE : Dates + Actions -->
            <div class="plaidoyer-topbar card p-4 mb-4">
              <div class="d-flex justify-content-between align-items-center flex-wrap gap-3 mb-3">
                <h2 class="fw-bold mb-0"><i class="fas fa-chart-pie text-primary me-2"></i>Plaidoyer</h2>
                <div class="d-flex gap-2 flex-wrap">
                  <button class="btn btn-sm btn-outline-secondary" onclick="openConfigViewerModal()"><i class="fas fa-list me-1"></i> Stats listes config</button>
                  <button class="btn btn-sm btn-outline-primary layout-toggle-btn" id="btn-layout-mode" onclick="toggleLayoutMode()"><i class="fas fa-th me-1"></i> Disposer</button>
                  <button class="btn btn-sm btn-dark" onclick="openCopyWidgetsModal()"><i class="fas fa-copy me-1"></i> Copier</button>
                </div>
              </div>

              <div class="row g-3 align-items-end">
                <div class="col-md-3">
                  <label class="form-label">Date Début</label>
                  <input type="date" class="form-control" id="stats-start">
                </div>
                <div class="col-md-3">
                  <label class="form-label">Date Fin</label>
                  <input type="date" class="form-control" id="stats-end">
                </div>
                <div class="col-md-6 d-flex gap-2 flex-wrap align-items-end">
                  <button class="btn btn-outline-primary btn-sm" onclick="setQuickDate(7)">7 derniers jours</button>
                  <button class="btn btn-outline-primary btn-sm" onclick="setQuickDate(30)">Dernier mois</button>
                  <button class="btn btn-primary text-white" onclick="computeWidgets()"><i class="fas fa-calculator me-1"></i> Calculer</button>
                </div>
              </div>
            </div>

            <!-- BOUTONS AJOUT WIDGETS -->
            <div class="d-flex gap-2 mb-4 flex-wrap">
              <button class="btn btn-outline-primary" onclick="openCreateStatModal()"><i class="fas fa-plus-circle me-1"></i> Créer une stat</button>
              <button class="btn btn-outline-primary" onclick="openAddSingleItemModal()"><i class="fas fa-plus me-1"></i> Ajouter une stat</button>
              <button class="btn btn-outline-primary" onclick="openAddItemListModal()"><i class="fas fa-th-list me-1"></i> Ajouter une liste</button>
            </div>

            <!-- GRILLE DE WIDGETS -->
            <div id="widgets-grid" class="widgets-grid">
              <div class="text-center text-muted py-5 w-100" id="widgets-empty">
                <i class="fas fa-puzzle-piece fa-3x mb-3 text-primary" style="opacity:0.3"></i>
                <p>Ajoutez vos premiers widgets pour personnaliser votre vue Plaidoyer.</p>
                <div class="d-flex gap-2 justify-content-center">
                  <button class="btn btn-sm btn-outline-primary" onclick="openCreateStatModal()"><i class="fas fa-plus-circle me-1"></i> Créer une stat</button>
                  <button class="btn btn-sm btn-outline-primary" onclick="openAddSingleItemModal()"><i class="fas fa-plus me-1"></i> Ajouter une stat</button>
                  <button class="btn btn-sm btn-outline-primary" onclick="openAddItemListModal()"><i class="fas fa-th-list me-1"></i> Ajouter une liste</button>
                </div>
              </div>
            </div>

          </div>
          
          <!-- ============================================ -->
          <!--               VUE RAPPELS                    -->
          <!-- ============================================ -->
          <div id="view-rappels" class="content-view d-none">
            <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
              <h2 class="fw-bold"><i class="fas fa-bell text-warning me-2"></i>Rappels & Suivi</h2>
              <div class="d-flex gap-2">
                <!-- C16 : Bouton nouveau rappel depuis vue Rappels -->
                <button class="btn btn-sm btn-primary" onclick="openRappelFromViewModal()"><i class="fas fa-plus me-1"></i> Nouveau Rappel</button>
                <button class="btn btn-sm btn-outline-secondary" onclick="loadRappels()"><i class="fas fa-sync"></i> Actualiser</button>
              </div>
            </div>

            <!-- NOUVEAU : Onglets rappels (En retard / À faire / Archivés) -->
            <ul class="nav nav-tabs mb-3" id="rappels-tabs" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="tab-enretard" data-bs-toggle="tab" data-bs-target="#pane-enretard" type="button" role="tab">
                  <i class="fas fa-exclamation-circle text-danger me-1"></i> En retard <span class="badge bg-danger ms-1" id="tab-enretard-count">0</span>
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-afaire" data-bs-toggle="tab" data-bs-target="#pane-afaire" type="button" role="tab">
                  <i class="fas fa-clock text-primary me-1"></i> À faire <span class="badge bg-primary ms-1" id="tab-afaire-count">0</span>
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-archives" data-bs-toggle="tab" data-bs-target="#pane-archives" type="button" role="tab">
                  <i class="fas fa-archive text-secondary me-1"></i> Archivés <span class="badge bg-secondary ms-1" id="tab-archives-count">0</span>
                </button>
              </li>
            </ul>
            <div class="tab-content" id="rappels-tab-content">
              <div class="tab-pane fade show active" id="pane-enretard" role="tabpanel">
                <div id="rappels-enretard-container" class="row g-3"></div>
              </div>
              <div class="tab-pane fade" id="pane-afaire" role="tabpanel">
                <div id="rappels-afaire-container" class="row g-3"></div>
              </div>
              <div class="tab-pane fade" id="pane-archives" role="tabpanel">
                <div id="rappels-archives-container" class="row g-3"></div>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- ============================================ -->
    <!--      BARRE FLOTTANTE ACTIONS (SELECTION)     -->
    <!-- ============================================ -->
    <div id="floating-bar" class="floating-action-bar">
      <span class="fw-bold"><span id="count-selected">0</span> jeunes sélectionnés</span>
      <button class="btn btn-warning btn-sm text-dark fw-bold" onclick="openMassEventModal()"><i class="fas fa-bolt me-1"></i> Appliquer un Événement</button>
      <button class="btn btn-sm btn-outline-light rounded-circle" onclick="clearSelection()"><i class="fas fa-times"></i></button>
    </div>

    <!-- ============================================ -->
    <!--         MODALE : FICHE JEUNE                 -->
    <!-- ============================================ -->
    <div class="modal fade" id="modalFicheJeune" tabindex="-1">
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <!-- U6 : Fil d'Ariane -->
            <div>
              <a id="breadcrumb-back" class="breadcrumb-back d-none" onclick="breadcrumbGoBack()"><i class="fas fa-arrow-left"></i> <span id="breadcrumb-text">Retour</span></a>
              <h5 class="modal-title fw-bold text-primary mb-0">Dossier Jeune</h5>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="row">
              <!-- COLONNE GAUCHE : INFOS -->
              <div class="col-md-4 border-end">
                <div class="text-center mb-4">
                  <div class="avatar bg-light rounded-circle d-inline-flex align-items-center justify-content-center mb-2" style="width: 80px; height: 80px;">
                    <i class="fas fa-user fa-3x text-secondary"></i>
                  </div>
                  <h3 id="fiche-nom" class="fw-bold mb-0"></h3>
                  <div class="text-muted small mb-2" id="fiche-surnom"></div>
                  <button class="btn btn-outline-primary btn-sm rounded-pill px-3" onclick="openEditProfile()"><i class="fas fa-pen me-2"></i>Modifier</button>
                </div>
                
                <div id="btn-see-group" class="d-grid mt-2 mb-3 d-none">
                  <button class="btn btn-sm btn-primary text-white" onclick="showGroupMembers()"><i class="fas fa-users me-2"></i>Voir le groupe</button>
                </div>

                <!-- NOUVEAU : Bouton Lier à un autre jeune/groupe -->
                <div class="d-grid mb-3">
                  <button class="btn btn-sm btn-outline-primary" onclick="openGroupLinkModal('fiche')"><i class="fas fa-link me-2"></i>Lier à un autre jeune / groupe</button>
                </div>

                <div class="p-3 bg-light rounded mb-3">
                  <div class="d-flex justify-content-between mb-2"><strong>Tel:</strong> <span id="fiche-tel"></span></div>
                  <div class="d-flex justify-content-between mb-2"><strong>Age:</strong> <span id="fiche-age"></span></div>
                  <div class="d-flex justify-content-between mb-2"><strong>Genre:</strong> <span id="fiche-genre"></span></div>
                  <div class="d-flex justify-content-between mb-2"><strong>Nat:</strong> <span id="fiche-nat"></span></div>
                  <div class="d-flex justify-content-between mb-2"><strong>Lieu:</strong> <span id="fiche-lieu"></span></div>
                  <!-- C9 : Date dernière distribution -->
                  <div class="d-flex justify-content-between mb-2"><strong>Dern. Contact:</strong> <span id="fiche-date-contact" class="small"></span></div>
                  <div class="d-flex justify-content-between mb-2"><strong>Dern. Rencontre:</strong> <span id="fiche-date-rencontre" class="small"></span></div>
                  <div class="d-flex justify-content-between"><strong>Dern. Distrib:</strong> <span id="fiche-date-distrib" class="small"></span></div>
                </div>
                
                <div class="mb-4">
                  <small class="text-uppercase text-muted fw-bold">Statuts</small>
                  <div class="mt-2 d-flex flex-column gap-2">
                    <span class="badge bg-primary text-start p-2" id="fiche-statut-mab-full"></span>
                    <span class="badge bg-light text-dark border text-start p-2" id="fiche-motif-mab" style="font-size:0.78em;"></span>
                    <span class="badge bg-secondary text-start p-2" id="fiche-statut-presence-full"></span>
                  </div>
                </div>
                
                <div class="alert alert-warning py-2 mb-3 small d-flex align-items-center">
                  <i class="fas fa-exclamation-circle me-2"></i>
                  <span id="fiche-notes-fixes" class="fw-bold"></span>
                </div>

                <div class="mb-3">
                  <small class="text-uppercase text-muted fw-bold">Vulnérabilités</small>
                  <div id="fiche-vulns" class="mt-2 d-flex flex-wrap gap-1"></div>
                </div>
                
                <div class="mb-3">
                  <small class="text-uppercase text-muted fw-bold">Labels / Autres Assos</small>
                  <div id="fiche-labels" class="mt-2 d-flex flex-wrap gap-1"></div>
                </div>

                <div class="d-grid mt-4 gap-2">
                  <button class="btn btn-outline-primary" onclick="openAddReminderModal()"><i class="fas fa-bell me-2"></i> Ajouter un Rappel</button>
                  <button class="btn btn-dark" onclick="generateReport()"><i class="fas fa-file-alt me-2"></i> Générer Rapport / IP</button>
                </div>
              </div>

              <!-- COLONNE DROITE : HISTORIQUE -->
              <div class="col-md-8">
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <h5 class="fw-bold m-0">Historique & Parcours</h5>
                  <button class="btn btn-primary text-white fw-bold" onclick="openAddEventModal()"><i class="fas fa-plus-circle me-2"></i>Nouvel Événement</button>
                </div>
                
                <div class="form-check form-switch mb-3">
                  <input class="form-check-input" type="checkbox" id="show-tech-history" onchange="renderTimeline()">
                  <label class="form-check-label small text-muted" for="show-tech-history">Voir les modifications techniques</label>
                </div>

                <div id="fiche-timeline" class="bg-white p-3 rounded border" style="max-height: 500px; overflow-y: auto;"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- ============================================ -->
    <!--          MODALE : RAPPORT IP                 -->
    <!-- ============================================ -->
    <div class="modal fade" id="modalReport" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Rapport Généré (Information Préoccupante)</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <textarea id="report-text" class="form-control" rows="20" style="font-family: monospace; font-size: 0.85em;"></textarea>
          </div>
          <div class="modal-footer">
            <button class="btn btn-primary" onclick="copyReport()"><i class="fas fa-copy me-2"></i>Copier le texte</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ============================================ -->
    <!--       MODALE : MEMBRES DU GROUPE             -->
    <!-- ============================================ -->
    <div class="modal fade" id="modalGroupMembers" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Membres du Groupe</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body" id="group-members-list">Chargement...</div>
        </div>
      </div>
    </div>

    <!-- ============================================ -->
    <!--       MODALE : AJOUTER RAPPEL (FICHE)        -->
    <!-- ============================================ -->
    <div class="modal fade" id="modalAddReminder" tabindex="-1" style="z-index: 1070;">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Ajouter un Rappel</h5>
            <button type="button" class="btn-close" onclick="closeAddReminderModal()"></button>
          </div>
          <div class="modal-body">
            <form id="form-rappel">
              <div class="mb-3">
                <label class="form-label">Titre</label>
                <input type="text" class="form-control" id="rappel-titre" placeholder="Ex: Prendre des nouvelles">
              </div>
              <!-- M7 : Type de rappel -->
              <div class="mb-3">
                <label class="form-label">Type de rappel</label>
                <div id="rappel-type" class="custom-dropdown" data-config="TYPES_RAPPELS" data-mode="single" data-placeholder="Sélectionner..."></div>
              </div>
              <div class="mb-3">
                <label class="form-label">Date d'échéance</label>
                <input type="date" class="form-control" id="rappel-date">
              </div>
              <div class="mb-3">
                <label class="form-label">Détails</label>
                <textarea class="form-control" id="rappel-details" rows="2"></textarea>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary w-100" onclick="soumettreRappelManuel()">Créer le Rappel</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ============================================ -->
    <!--  C16 : MODALE : NOUVEAU RAPPEL (VUE RAPPELS) -->
    <!-- ============================================ -->
    <div class="modal fade" id="modalRappelFromView" tabindex="-1" style="z-index: 1070;">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title"><i class="fas fa-bell me-2"></i>Nouveau Rappel</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form id="form-rappel-from-view">
              <!-- Recherche du jeune -->
              <div class="mb-3">
                <label class="form-label fw-bold">Rechercher le jeune</label>
                <input type="text" class="form-control" id="rappel-view-search" placeholder="Nom, surnom ou téléphone..." oninput="searchJeuneForRappelView(this.value)">
                <input type="hidden" id="rappel-view-id-jeune" value="">
                <div id="rappel-view-search-results" class="rappel-search-results d-none"></div>
                <div id="rappel-view-selected" class="mt-2 d-none">
                  <span class="badge bg-primary p-2" id="rappel-view-selected-name"></span>
                  <button type="button" class="btn btn-sm btn-link text-danger" onclick="clearRappelViewSelection()"><i class="fas fa-times"></i></button>
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label">Titre</label>
                <input type="text" class="form-control" id="rappel-view-titre" placeholder="Ex: Prendre des nouvelles">
              </div>
              <!-- M7 : Type de rappel -->
              <div class="mb-3">
                <label class="form-label">Type de rappel</label>
                <div id="rappel-view-type" class="custom-dropdown" data-config="TYPES_RAPPELS" data-mode="single" data-placeholder="Sélectionner..."></div>
              </div>
              <div class="mb-3">
                <label class="form-label">Date d'échéance</label>
                <input type="date" class="form-control" id="rappel-view-date">
              </div>
              <div class="mb-3">
                <label class="form-label">Détails</label>
                <textarea class="form-control" id="rappel-view-details" rows="2"></textarea>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary w-100" onclick="soumettreRappelFromView()">Créer le Rappel</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ============================================ -->
    <!--       MODALE : MODIFIER RAPPEL               -->
    <!-- ============================================ -->
    <div class="modal fade" id="modalUpdateReminder" tabindex="-1" style="z-index: 1070;">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Modifier le Rappel</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form id="form-update-rappel">
              <input type="hidden" id="update-rappel-id">
              <div class="mb-3">
                <label class="form-label">Date d'échéance</label>
                <input type="date" class="form-control" id="update-rappel-date">
              </div>
              <div class="mb-3">
                <label class="form-label">Détails</label>
                <textarea class="form-control" id="update-rappel-details" rows="2"></textarea>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" onclick="soumettreUpdateRappel()">Enregistrer</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ============================================ -->
    <!--       MODALE : CLOTURER RAPPEL               -->
    <!-- ============================================ -->
    <div class="modal fade" id="modalCloseReminder" tabindex="-1" style="z-index: 1070;">
      <div class="modal-dialog modal-sm">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Clôturer le rappel</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body text-center">
            <p>Quel statut pour ce rappel ?</p>
            <input type="hidden" id="close-rappel-id">
            <div class="d-grid gap-2">
              <button class="btn btn-success" onclick="soumettreCloseRappel('Fait')"><i class="fas fa-check me-2"></i> Fait</button>
              <button class="btn btn-secondary" onclick="soumettreCloseRappel('Abandonné')"><i class="fas fa-times me-2"></i> Abandonné</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- ============================================ -->
    <!--       MODALE : MODIFIER PROFIL               -->
    <!-- ============================================ -->
    <div class="modal fade" id="modalEditProfile" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Modifier Informations</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form id="form-edit-profile">
              <div class="mb-3">
                <label class="form-label">Nom / Alias</label>
                <input type="text" class="form-control" id="edit-nom">
              </div>
              <div class="mb-3">
                <label class="form-label">Surnom</label>
                <input type="text" class="form-control" id="edit-surnom">
              </div>
              <div class="mb-3">
                <label class="form-label">Téléphone</label>
                <input type="text" class="form-control" id="edit-tel">
              </div>
              <div class="row mb-3">
                <div class="col-6">
                  <label class="form-label">Age</label>
                  <input type="number" class="form-control" id="edit-age">
                </div>
                <div class="col-6">
                  <label class="form-label">Lieu de vie</label>
                  <div id="edit-lieu" class="custom-dropdown" data-config="LIEUX_VIE" data-mode="single" data-placeholder="Sélectionner..."></div>
                </div>
              </div>
              <hr>
              <div class="mb-3">
                <label class="form-label fw-bold">Statut MAB</label>
                <div id="edit-statut-mab" class="custom-dropdown" data-config="STATUTS_MAB" data-mode="single" data-placeholder="Sélectionner..."></div>
              </div>
              <div class="mb-3">
                <label class="form-label fw-bold">Statut Présence</label>
                <div id="edit-statut-pres" class="custom-dropdown" data-config="STATUT_PRESENCE" data-mode="single" data-placeholder="Sélectionner..."></div>
              </div>
              <hr>
              <div class="mb-3">
                <label class="form-label text-warning fw-bold">Note Fixe</label>
                <textarea class="form-control" id="edit-notes-fixes" rows="2"></textarea>
              </div>
              <div class="mb-3">
               <label class="form-label text-primary fw-bold">Labels / Autres Assos</label>
              <div id="edit-labels" class="custom-dropdown" data-config="LABELS_CONTACTS_AUTRES" data-mode="multi" data-placeholder="Sélectionner..."></div>
              </div>
              <hr>
              <div class="mb-3">
                <label class="form-label text-danger fw-bold">Vulnérabilités</label>
              <div id="edit-vulns" class="custom-dropdown" data-config="VULNERABILITES_TAGS" data-mode="multi" data-placeholder="Sélectionner..."></div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" onclick="saveEditProfile()">Enregistrer</button>
        </div>
      </div>
    </div>
  </div>
    
    <!-- ============================================ -->
    <!--       MODALE : MODIFIER EVENEMENT            -->
    <!-- ============================================ -->
    <div class="modal fade" id="modalEditEvent" tabindex="-1" style="z-index: 1080;">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-warning text-dark">
            <h5 class="modal-title">Modifier l'événement</h5>
            <button type="button" class="btn-close" onclick="closeEditEventModal()"></button>
          </div>
          <div class="modal-body">
            <form id="form-edit-event">
              <input type="hidden" id="edit-event-id">
              <div class="mb-3">
                <label class="form-label">Date</label>
                <input type="date" class="form-control" id="edit-event-date">
              </div>
              <div class="mb-3">
                <label class="form-label">Type</label>
                <div id="edit-event-type" class="custom-dropdown" data-config="TYPES_EVENEMENTS" data-mode="single" data-placeholder="Sélectionner..."></div>
              </div>
              <div class="mb-3">
                <label class="form-label">Détails</label>
                <textarea class="form-control" id="edit-event-details" rows="3"></textarea>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button class="btn btn-primary" onclick="saveEditedEvent()">Enregistrer</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ============================================ -->
    <!--       MODALE : NOUVEL EVENEMENT              -->
    <!-- ============================================ -->
    <div class="modal fade" id="modalAddEvent" tabindex="-1" style="z-index: 1060;">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-warning text-dark">
            <h5 class="modal-title fw-bold" id="modal-event-title">Nouvel Événement</h5>
            <button type="button" class="btn-close" onclick="closeAddEventModal()"></button>
          </div>
          <div class="modal-body">
            <form id="form-event">
              <input type="hidden" id="event-id-jeune">
              <div class="mb-3">
                <label class="form-label fw-bold">Type d'événement</label>
                <div id="event-type" class="custom-dropdown" data-config="TYPES_EVENEMENTS" data-mode="single" data-placeholder="Sélectionner..." data-onchange="updateFormFields"></div>
              </div>
              <div class="row mb-3">
                <div class="col-6">
                  <label class="form-label">Date</label>
                  <input type="date" class="form-control" id="event-date">
                </div>
                <div class="col-6 d-none" id="group-event-lieuevent">
                  <label class="form-label">Lieu Événement</label>
                  <div id="event-lieuevent" class="custom-dropdown" data-config="LIEUX_EVENTS" data-mode="single" data-placeholder="Sélectionner..."></div>
                </div>
              </div>
              <div class="mb-3 d-none" id="group-event-contact">
                <label class="form-label">Type Contact</label>
                <div id="event-contact" class="custom-dropdown" data-config="TYPES_CONTACT" data-mode="multi" data-placeholder="Sélectionner..."></div>
              </div>
              <div class="mb-3 d-none p-3 bg-light rounded border" id="group-event-lieuvie">
                <label class="form-label text-primary fw-bold">Mise à jour Lieu de Vie</label>
                <div id="event-lieuvie" class="custom-dropdown" data-config="LIEUX_VIE" data-mode="single" data-placeholder="Sélectionner..."></div>
              </div>
              <div class="mb-3 d-none p-3 bg-light rounded border" id="group-event-mab">
                <label class="form-label text-primary fw-bold">Nouveau Statut MAB</label>
                <div id="event-statut-mab" class="custom-dropdown" data-config="STATUTS_MAB" data-mode="single" data-placeholder="Sélectionner..."></div>
              </div>
              <div class="mb-3 d-none p-3 bg-light rounded border" id="group-event-presence">
                <label class="form-label text-primary fw-bold">Nouveau Statut Présence</label>
                <div id="event-statut-presence" class="custom-dropdown" data-config="STATUT_PRESENCE" data-mode="single" data-placeholder="Sélectionner..."></div>
              </div>
              <!-- M1 : Renommé de "Motif Refus" à "Motif Statut MAB" -->
              <div class="mb-3 d-none" id="group-event-refus">
                <label class="form-label text-danger fw-bold">Motif Statut MAB</label>
                <div id="event-motif-statut-mab" class="custom-dropdown" data-config="MOTIF_STATUT_MAB" data-mode="multi" data-placeholder="Sélectionner..."></div>
              </div>
              <div class="mb-3 d-none p-3 bg-light rounded border" id="group-event-materiel">
                <label class="form-label fw-bold">Matériel Distribué</label>
                <div id="event-materiel" class="custom-dropdown" data-config="MATERIEL" data-mode="multi" data-placeholder="Sélectionner..."></div>
              </div>
              <div class="mb-3 d-none p-3 bg-light rounded border" id="group-event-vulns">
                <label class="form-label text-primary fw-bold">Ajouter Vulnérabilité</label>
                <div id="event-vulns" class="custom-dropdown" data-config="VULNERABILITES_TAGS" data-mode="multi" data-placeholder="Sélectionner..."></div>
              </div>
              <div class="mb-3 d-none" id="group-event-note">
                <label class="form-label">Note / Détails</label>
                <textarea class="form-control" id="event-note" rows="2"></textarea>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary w-100" onclick="soumettreEvent()">Valider</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ============================================ -->
    <!--       MODALE : CONFLIT DOUBLON               -->
    <!-- ============================================ -->
    <div class="modal fade" id="modalConflit" tabindex="-1" data-bs-backdrop="static">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-warning text-dark">
            <h5 class="modal-title">Numéro existant</h5>
          </div>
          <div class="modal-body">
            <p>Déjà attribué à : <strong id="conflit-noms"></strong>.</p>
            <div class="d-grid gap-2">
              <button class="btn btn-primary" onclick="resoudreConflit('JOIN_GROUP')">Même groupe (Fratrie...)</button>
              <button class="btn btn-danger" onclick="resoudreConflit('NEW_OWNER')">Nouveau propriétaire (Rotation SIM)</button>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ============================================ -->
    <!--  C6 : MODALE : EVICTION PAR LIEU DE VIE      -->
    <!-- ============================================ -->
    <div class="modal fade" id="modalEviction" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-danger text-white">
            <h5 class="modal-title"><i class="fas fa-house-chimney-crack me-2"></i>Éviction rapide par Lieu de Vie</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <p class="text-muted small">Sélectionnez un lieu de vie. Tous les jeunes actifs sur ce lieu seront ajoutés au panier, et le formulaire d'événement sera pré-rempli sur "Éviction".</p>
            <div class="mb-3">
              <label class="form-label fw-bold">Lieu de vie concerné</label>
              <div id="eviction-lieu" class="custom-dropdown" data-config="LIEUX_VIE" data-mode="single" data-placeholder="Sélectionner..." data-onchange="onEvictionLieuChange"></div>
            </div>
            <div id="eviction-preview" class="d-none">
              <div class="alert alert-info py-2 small">
                <i class="fas fa-users me-1"></i> <strong id="eviction-count">0</strong> jeune(s) trouvé(s) sur ce lieu.
              </div>
              <div id="eviction-list" style="max-height: 200px; overflow-y: auto;"></div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Annuler</button>
            <button type="button" class="btn btn-danger" id="btn-confirm-eviction" onclick="confirmEviction()" disabled><i class="fas fa-check me-2"></i>Confirmer & Ouvrir Événement</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ============================================ -->
    <!--  NOUVEAU : MODALE COMMENTAIRE RAPPEL         -->
    <!-- ============================================ -->
    <div class="modal fade" id="modalAddComment" tabindex="-1" style="z-index: 1070;">
      <div class="modal-dialog modal-sm">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title"><i class="fas fa-comment me-2"></i>Ajouter un commentaire</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="comment-rappel-id">
            <div class="mb-3">
              <label class="form-label">Commentaire</label>
              <textarea class="form-control" id="comment-text" rows="3" placeholder="Ex: Appelé, pas de réponse..."></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary text-white w-100" onclick="soumettreCommentRappel()"><i class="fas fa-check me-2"></i>Ajouter</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ============================================ -->
    <!--  NOUVEAU : MODALE GERER FAVORIS (STATS)      -->
    <!-- ============================================ -->
    <div class="modal fade" id="modalManageFavoris" tabindex="-1" style="z-index: 1070;">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-warning text-dark">
            <h5 class="modal-title"><i class="fas fa-star me-2"></i>Gérer les Favoris</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <p class="text-muted small">Vos listes favorites apparaissent en priorité après le calcul des statistiques. Vous pouvez les modifier ou les supprimer ici.</p>
            <div id="manage-favoris-list">
              <p class="text-muted text-center py-3">Aucun favori créé.</p>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-warning" onclick="closeManageFavorisAndCreate()"><i class="fas fa-plus me-1"></i> Créer un nouveau favori</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ============================================ -->
    <!--  NOUVEAU : MODALE CREER/EDITER FAVORI        -->
    <!-- ============================================ -->
    <div class="modal fade" id="modalCustomizeFavori" tabindex="-1" style="z-index: 1080;">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header bg-warning text-dark">
            <h5 class="modal-title"><i class="fas fa-star me-2"></i>Créer une liste favorite</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="favori-edit-index" value="-1">
            <div class="mb-3">
              <label class="form-label fw-bold">Nom de la liste</label>
              <input type="text" class="form-control" id="favori-name" placeholder="Ex: Chiffres clés évictions, Vulnérabilités prioritaires...">
            </div>
            <p class="text-muted small">Cochez les items que vous souhaitez inclure dans cette liste favorite. Tous les items de BDD_CONFIG sont disponibles, y compris ceux à 0. Les items sélectionnés avec un compte de 0 apparaîtront grisés en bas de la liste.</p>
            <div id="favori-items-selector" class="favori-selector">
              <!-- Rempli dynamiquement par JS avec les checkboxes regroupées par catégorie -->
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-warning" onclick="saveFavori()"><i class="fas fa-save me-1"></i> Enregistrer</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ============================================ -->
    <!--  NOUVEAU : MODALE LIAISON GROUPE             -->
    <!-- ============================================ -->
    <div class="modal fade" id="modalGroupLink" tabindex="-1" style="z-index: 1090;">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title"><i class="fas fa-link me-2"></i>Lier à un groupe</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="group-link-context" value="">
            <p class="text-muted small mb-3">Recherchez des jeunes par nom, surnom ou téléphone, puis sélectionnez ceux que vous souhaitez lier au même groupe.</p>
            
            <div class="mb-3">
              <label class="form-label fw-bold">Rechercher</label>
              <div class="input-group">
                <input type="text" class="form-control" id="group-link-search" placeholder="Nom, surnom ou téléphone..." oninput="searchJeunesForGroupLinkUI(this.value)">
                <button class="btn btn-outline-primary" type="button" onclick="searchJeunesForGroupLinkUI(document.getElementById('group-link-search').value)"><i class="fas fa-search"></i></button>
              </div>
            </div>

            <!-- Résultats de recherche -->
            <div id="group-link-results" class="mb-3" style="max-height: 250px; overflow-y: auto;">
              <p class="text-muted text-center small py-3">Les résultats apparaîtront ici.</p>
            </div>

            <!-- Jeunes sélectionnés -->
            <div class="border-top pt-3">
              <label class="form-label fw-bold"><i class="fas fa-check-circle text-success me-1"></i> Jeunes sélectionnés pour le groupe</label>
              <div id="group-link-selected" class="d-flex flex-wrap gap-2">
                <span class="text-muted small">Aucun jeune sélectionné.</span>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Annuler</button>
            <button type="button" class="btn btn-primary text-white" onclick="confirmGroupLink()"><i class="fas fa-check me-2"></i>Confirmer la liaison</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ============================================ -->
    <!--  PHASE 3.1 : MODALE CREER UNE STAT (MULTI)  -->
    <!-- ============================================ -->
    <div class="modal fade" id="modalCreateStat" tabindex="-1" style="z-index: 1080;">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title"><i class="fas fa-plus-circle me-2"></i>Créer une stat personnalisée</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <p class="text-muted small mb-3">Combinez des conditions sur les <strong>personnes</strong> et/ou les <strong>événements</strong> pour obtenir un chiffre précis.</p>
            
            <div class="row mb-3">
              <div class="col-md-8">
                <label class="form-label fw-bold">Titre du widget</label>
                <input type="text" class="form-control" id="cs-title" placeholder="Ex: Filles actives ayant subi un refus MAB">
              </div>
              <div class="col-md-4">
                <label class="form-label">Emoji</label>
                <input type="text" class="form-control" id="cs-emoji" value="📊" maxlength="4">
              </div>
            </div>

            <!-- ZONE CONDITIONS -->
            <div class="mb-3">
              <label class="form-label fw-bold"><i class="fas fa-filter me-1 text-primary"></i> Conditions</label>
              <div id="cs-conditions-list">
                <!-- Les conditions s'ajoutent ici dynamiquement -->
              </div>
              <div class="d-flex gap-2 mt-2">
                <button type="button" class="btn btn-sm btn-outline-primary" onclick="addCSCondition('jeunes')">
                  <i class="fas fa-user me-1"></i> + Condition sur les personnes
                </button>
                <button type="button" class="btn btn-sm btn-outline-warning" onclick="addCSCondition('events')">
                  <i class="fas fa-calendar me-1"></i> + Condition sur les événements
                </button>
              </div>
            </div>

            <!-- INFO AUTO-DETECTION -->
            <div class="alert alert-info py-2 small" id="cs-auto-info">
              <i class="fas fa-magic me-1"></i> <span id="cs-auto-info-text">Ajoutez des conditions pour définir votre requête.</span>
            </div>

            <!-- OPTIONS -->
            <div class="row mb-3">
              <div class="col-md-4">
                <label class="form-label">Couleur</label>
                <div class="d-flex gap-2" id="cs-color-picker">
                  <span class="widget-color-swatch wc-teal-1 active" data-color="teal-1" onclick="pickColor('cs', this)"></span>
                  <span class="widget-color-swatch wc-teal-2" data-color="teal-2" onclick="pickColor('cs', this)"></span>
                  <span class="widget-color-swatch wc-teal-3" data-color="teal-3" onclick="pickColor('cs', this)"></span>
                  <span class="widget-color-swatch wc-teal-4" data-color="teal-4" onclick="pickColor('cs', this)"></span>
                  <span class="widget-color-swatch wc-teal-5" data-color="teal-5" onclick="pickColor('cs', this)"></span>
                  <span class="widget-color-swatch wc-teal-6" data-color="teal-6" onclick="pickColor('cs', this)"></span>
                </div>
              </div>
              <div class="col-md-2">
                <label class="form-label">Largeur</label>
                <input type="number" class="form-control" id="cs-colspan" value="3" min="1" max="12">
                <small class="text-muted">colonnes</small>
              </div>
              <div class="col-md-2">
                <label class="form-label">Hauteur</label>
                <input type="number" class="form-control" id="cs-rowspan" value="2" min="1" max="8">
                <small class="text-muted">lignes</small>
              </div>
              <div class="col-md-4">
                <label class="form-label">Compter</label>
                <select class="form-select" id="cs-result-mode">
                  <option value="jeunes">Nombre de personnes</option>
                  <option value="events">Nombre d'événements</option>
                </select>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
            <button type="button" class="btn btn-primary text-white" onclick="saveCreateStatWidget()"><i class="fas fa-check me-1"></i> Créer le widget</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ============================================ -->
    <!--  PHASE 3 : MODALE AJOUTER UNE STAT          -->
    <!-- ============================================ -->
    <div class="modal fade" id="modalAddSingleItem" tabindex="-1" style="z-index: 1080;">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title"><i class="fas fa-plus me-2"></i>Ajouter une stat</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <p class="text-muted small mb-3">Choisissez un item d'une liste BDD_CONFIG pour l'afficher comme carte chiffrée.</p>
            
            <div class="mb-3">
              <label class="form-label fw-bold">Catégorie</label>
              <select class="form-select" id="asi-category" onchange="updateASIItems()">
                <option value="">— Choisir —</option>
                <option value="_subcards">Indicateurs Globaux</option>
                <!-- Rempli dynamiquement -->
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label fw-bold">Item</label>
              <select class="form-select" id="asi-item">
                <option value="">— Choisir une catégorie d'abord —</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Titre personnalisé (optionnel)</label>
              <input type="text" class="form-control" id="asi-title" placeholder="Laissez vide pour le nom de l'item">
            </div>
            <div class="row mb-3">
              <div class="col-6">
                <label class="form-label">Emoji</label>
                <input type="text" class="form-control" id="asi-emoji" value="📈" maxlength="4">
              </div>
              <div class="col-3">
                <label class="form-label">Largeur</label>
                <input type="number" class="form-control" id="asi-colspan" value="2" min="1" max="12">
              </div>
              <div class="col-3">
                <label class="form-label">Hauteur</label>
                <input type="number" class="form-control" id="asi-rowspan" value="2" min="1" max="8">
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Couleur</label>
              <div class="d-flex gap-2" id="asi-color-picker">
                <span class="widget-color-swatch wc-teal-1 active" data-color="teal-1" onclick="pickColor('asi', this)"></span>
                <span class="widget-color-swatch wc-teal-2" data-color="teal-2" onclick="pickColor('asi', this)"></span>
                <span class="widget-color-swatch wc-teal-3" data-color="teal-3" onclick="pickColor('asi', this)"></span>
                <span class="widget-color-swatch wc-teal-4" data-color="teal-4" onclick="pickColor('asi', this)"></span>
                <span class="widget-color-swatch wc-teal-5" data-color="teal-5" onclick="pickColor('asi', this)"></span>
                <span class="widget-color-swatch wc-teal-6" data-color="teal-6" onclick="pickColor('asi', this)"></span>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
            <button type="button" class="btn btn-primary text-white" onclick="saveSingleItemWidget()"><i class="fas fa-check me-1"></i> Ajouter</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ============================================ -->
    <!--  PHASE 3 : MODALE AJOUTER UNE LISTE         -->
    <!-- ============================================ -->
    <div class="modal fade" id="modalAddItemList" tabindex="-1" style="z-index: 1080;">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title"><i class="fas fa-th-list me-2"></i>Ajouter une liste de stats</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <p class="text-muted small mb-3">Sélectionnez plusieurs items de n'importe quelle liste pour créer une grande carte déroulable.</p>
            
            <div class="mb-3">
              <label class="form-label fw-bold">Titre de la liste</label>
              <input type="text" class="form-control" id="ail-title" placeholder="Ex: Vulnérabilités prioritaires">
            </div>
            <div class="row mb-3">
              <div class="col-4">
                <label class="form-label">Emoji</label>
                <input type="text" class="form-control" id="ail-emoji" value="📋" maxlength="4">
              </div>
              <div class="col-4">
                <label class="form-label">Couleur</label>
                <div class="d-flex gap-2" id="ail-color-picker">
                  <span class="widget-color-swatch wc-teal-1 active" data-color="teal-1" onclick="pickColor('ail', this)"></span>
                  <span class="widget-color-swatch wc-teal-2" data-color="teal-2" onclick="pickColor('ail', this)"></span>
                  <span class="widget-color-swatch wc-teal-3" data-color="teal-3" onclick="pickColor('ail', this)"></span>
                  <span class="widget-color-swatch wc-teal-4" data-color="teal-4" onclick="pickColor('ail', this)"></span>
                  <span class="widget-color-swatch wc-teal-5" data-color="teal-5" onclick="pickColor('ail', this)"></span>
                  <span class="widget-color-swatch wc-teal-6" data-color="teal-6" onclick="pickColor('ail', this)"></span>
                </div>
              </div>
              <div class="col-2">
                <label class="form-label">Largeur</label>
                <input type="number" class="form-control" id="ail-colspan" value="4" min="1" max="12">
              </div>
              <div class="col-2">
                <label class="form-label">Hauteur</label>
                <input type="number" class="form-control" id="ail-rowspan" value="3" min="1" max="8">
              </div>
            </div>
             <hr>
            <div class="d-flex justify-content-between align-items-center mb-2">
              <label class="form-label fw-bold mb-0">Sélection des items</label>
              <div class="d-flex gap-1">
                <button type="button" class="btn btn-xs btn-outline-primary" onclick="ailCheckAll(true)" style="font-size:0.72rem; padding:2px 8px;">Tout cocher</button>
                <button type="button" class="btn btn-xs btn-outline-secondary" onclick="ailCheckAll(false)" style="font-size:0.72rem; padding:2px 8px;">Tout décocher</button>
              </div>
            </div>
            <div id="ail-items-selector" class="favori-selector" style="max-height:350px; overflow-y:auto;">
              <!-- Rempli dynamiquement -->
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
            <button type="button" class="btn btn-primary text-white" onclick="saveItemListWidget()"><i class="fas fa-check me-1"></i> Créer la liste</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ============================================ -->
    <!--  PHASE 3 : MODALE EDITER WIDGET              -->
    <!-- ============================================ -->
    <div class="modal fade" id="modalEditWidget" tabindex="-1" style="z-index: 1090;">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-warning text-dark">
            <h5 class="modal-title"><i class="fas fa-pen me-2"></i>Modifier le widget</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="ew-id">
            <div class="mb-3">
              <label class="form-label fw-bold">Titre</label>
              <input type="text" class="form-control" id="ew-title">
            </div>
            <div class="row mb-3">
              <div class="col-4">
                <label class="form-label">Emoji</label>
                <input type="text" class="form-control" id="ew-emoji" maxlength="4">
              </div>
              <div class="col-4">
                <label class="form-label">Largeur (col.)</label>
                <input type="number" class="form-control" id="ew-colspan" value="3" min="1" max="12">
              </div>
              <div class="col-4">
                <label class="form-label">Hauteur (lig.)</label>
                <input type="number" class="form-control" id="ew-rowspan" value="2" min="1" max="8">
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Couleur</label>
              <div class="d-flex gap-2" id="ew-color-picker">
                <span class="widget-color-swatch wc-teal-1" data-color="teal-1" onclick="pickColor('ew', this)"></span>
                <span class="widget-color-swatch wc-teal-2" data-color="teal-2" onclick="pickColor('ew', this)"></span>
                <span class="widget-color-swatch wc-teal-3" data-color="teal-3" onclick="pickColor('ew', this)"></span>
                <span class="widget-color-swatch wc-teal-4" data-color="teal-4" onclick="pickColor('ew', this)"></span>
                <span class="widget-color-swatch wc-teal-5" data-color="teal-5" onclick="pickColor('ew', this)"></span>
                <span class="widget-color-swatch wc-teal-6" data-color="teal-6" onclick="pickColor('ew', this)"></span>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Position (ordre d'affichage)</label>
              <input type="number" class="form-control" id="ew-order" min="0">
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-danger" onclick="deleteWidgetFromEdit()"><i class="fas fa-trash me-1"></i> Supprimer</button>
            <button type="button" class="btn btn-primary text-white" onclick="saveEditWidget()"><i class="fas fa-check me-1"></i> Enregistrer</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ============================================ -->
    <!--  PHASE 3 : MODALE COPIER WIDGETS             -->
    <!-- ============================================ -->
    <div class="modal fade" id="modalCopyWidgets" tabindex="-1" style="z-index: 1080;">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-dark text-white">
            <h5 class="modal-title"><i class="fas fa-copy me-2"></i>Copier les widgets</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <p class="text-muted small mb-3">Sélectionnez les widgets à copier, ou copiez tout.</p>
            <div class="mb-3">
              <button class="btn btn-sm btn-dark w-100 mb-2" onclick="copyAllWidgets()"><i class="fas fa-copy me-1"></i> Tout copier</button>
            </div>
            <div id="copy-widgets-list"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-dark" onclick="copySelectedWidgets()"><i class="fas fa-copy me-1"></i> Copier la sélection</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ============================================ -->
    <!--  PHASE 3 : MODALE CONFIG VIEWER              -->
    <!-- ============================================ -->
    <div class="modal fade" id="modalConfigViewer" tabindex="-1" style="z-index: 1080;">
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title"><i class="fas fa-list me-2"></i>Stats listes BDD_CONFIG</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <p class="text-muted small mb-3">Vue complète de toutes les listes avec les compteurs. <strong>Calculez les stats d'abord</strong> pour voir les chiffres.</p>
            <div id="config-viewer-content" class="stats-lists-grid">
              <p class="text-muted text-center py-4">Calculez les statistiques pour voir les données.</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ============================================ -->
    <!--  PHASE 4 : MODALE AJOUT WIDGET DASHBOARD     -->
    <!-- ============================================ -->
    <div class="modal fade" id="modalAddDashWidget" tabindex="-1" style="z-index: 1080;">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title"><i class="fas fa-plus-circle me-2"></i>Ajouter un widget au tableau de bord</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="row g-3 mb-4">
              <!-- Type selection -->
              <div class="col-6 col-md-3">
                <div class="card p-3 text-center h-100 dash-type-card" style="cursor:pointer; border:2px solid transparent;" onclick="selectDashWidgetType('dash_stat')" id="dwt-dash_stat">
                  <i class="fas fa-chart-bar fa-2x text-primary mb-2"></i>
                  <div class="fw-bold small">Statistique</div>
                  <div class="text-muted" style="font-size:0.65rem">Depuis Plaidoyer</div>
                </div>
              </div>
              <div class="col-6 col-md-3">
                <div class="card p-3 text-center h-100 dash-type-card" style="cursor:pointer; border:2px solid transparent;" onclick="selectDashWidgetType('dash_rappels')" id="dwt-dash_rappels">
                  <i class="fas fa-bell fa-2x text-warning mb-2"></i>
                  <div class="fw-bold small">Rappels</div>
                  <div class="text-muted" style="font-size:0.65rem">En retard & à faire</div>
                </div>
              </div>
              <div class="col-6 col-md-3">
                <div class="card p-3 text-center h-100 dash-type-card" style="cursor:pointer; border:2px solid transparent;" onclick="selectDashWidgetType('dash_action')" id="dwt-dash_action">
                  <i class="fas fa-bolt fa-2x text-success mb-2"></i>
                  <div class="fw-bold small">Action rapide</div>
                  <div class="text-muted" style="font-size:0.65rem">Raccourci cliquable</div>
                </div>
              </div>
              <div class="col-6 col-md-3">
                <div class="card p-3 text-center h-100 dash-type-card" style="cursor:pointer; border:2px solid transparent;" onclick="selectDashWidgetType('dash_jeune')" id="dwt-dash_jeune">
                  <i class="fas fa-user-tag fa-2x text-info mb-2"></i>
                  <div class="fw-bold small">Jeune épinglé</div>
                  <div class="text-muted" style="font-size:0.65rem">Fiche sur le dashboard</div>
                </div>
              </div>
            </div>

            <!-- Options dynamiques selon le type -->
            <div id="dw-options-area">
              <p class="text-muted text-center small">Choisissez un type de widget ci-dessus.</p>
            </div>

            <hr>
            <div class="row g-2">
              <div class="col-md-4">
                <label class="form-label small fw-bold">Titre (optionnel)</label>
                <input type="text" class="form-control form-control-sm" id="dw-custom-title" placeholder="Titre personnalisé...">
              </div>
              <div class="col-md-2">
                <label class="form-label small fw-bold">Emoji</label>
                <input type="text" class="form-control form-control-sm" id="dw-custom-emoji" value="📊" maxlength="4">
              </div>
              <div class="col-md-2">
                <label class="form-label small fw-bold">Largeur</label>
                <input type="number" class="form-control form-control-sm" id="dw-custom-colspan" value="3" min="1" max="12">
              </div>
              <div class="col-md-2">
                <label class="form-label small fw-bold">Hauteur</label>
                <input type="number" class="form-control form-control-sm" id="dw-custom-rowspan" value="2" min="1" max="8">
              </div>
              <div class="col-md-2">
                <label class="form-label small fw-bold">Couleur</label>
                <div class="d-flex gap-1 flex-wrap" id="dw-color-picker">
                  <span class="widget-color-swatch wc-teal-1 active" data-color="teal-1" onclick="pickColor('dw', this)" style="width:26px;height:26px;"></span>
                  <span class="widget-color-swatch wc-teal-2" data-color="teal-2" onclick="pickColor('dw', this)" style="width:26px;height:26px;"></span>
                  <span class="widget-color-swatch wc-teal-3" data-color="teal-3" onclick="pickColor('dw', this)" style="width:26px;height:26px;"></span>
                  <span class="widget-color-swatch wc-teal-4" data-color="teal-4" onclick="pickColor('dw', this)" style="width:26px;height:26px;"></span>
                  <span class="widget-color-swatch wc-teal-5" data-color="teal-5" onclick="pickColor('dw', this)" style="width:26px;height:26px;"></span>
                  <span class="widget-color-swatch wc-teal-6" data-color="teal-6" onclick="pickColor('dw', this)" style="width:26px;height:26px;"></span>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
            <button type="button" class="btn btn-primary text-white" onclick="saveDashWidget()"><i class="fas fa-check me-1"></i> Ajouter</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ============================================ -->
    <!--  PHASE 4 : MODALE EDITER WIDGET DASHBOARD    -->
    <!-- ============================================ -->
    <div class="modal fade" id="modalEditDashWidget" tabindex="-1" style="z-index: 1090;">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-warning text-dark">
            <h5 class="modal-title"><i class="fas fa-pen me-2"></i>Modifier le widget</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="edw-id">
            <div class="mb-3">
              <label class="form-label fw-bold">Titre</label>
              <input type="text" class="form-control" id="edw-title">
            </div>
            <div class="row mb-3">
              <div class="col-4">
                <label class="form-label">Emoji</label>
                <input type="text" class="form-control" id="edw-emoji" maxlength="4">
              </div>
              <div class="col-4">
                <label class="form-label">Largeur (col.)</label>
                <input type="number" class="form-control" id="edw-colspan" value="3" min="1" max="12">
              </div>
              <div class="col-4">
                <label class="form-label">Hauteur (lig.)</label>
                <input type="number" class="form-control" id="edw-rowspan" value="2" min="1" max="8">
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Couleur</label>
              <div class="d-flex gap-2" id="edw-color-picker">
                <span class="widget-color-swatch wc-teal-1" data-color="teal-1" onclick="pickColor('edw', this)"></span>
                <span class="widget-color-swatch wc-teal-2" data-color="teal-2" onclick="pickColor('edw', this)"></span>
                <span class="widget-color-swatch wc-teal-3" data-color="teal-3" onclick="pickColor('edw', this)"></span>
                <span class="widget-color-swatch wc-teal-4" data-color="teal-4" onclick="pickColor('edw', this)"></span>
                <span class="widget-color-swatch wc-teal-5" data-color="teal-5" onclick="pickColor('edw', this)"></span>
                <span class="widget-color-swatch wc-teal-6" data-color="teal-6" onclick="pickColor('edw', this)"></span>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Position (ordre)</label>
              <input type="number" class="form-control" id="edw-order" min="0">
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-danger" onclick="deleteDashWidgetFromEdit()"><i class="fas fa-trash me-1"></i> Supprimer</button>
            <button type="button" class="btn btn-primary text-white" onclick="saveEditDashWidget()"><i class="fas fa-check me-1"></i> Enregistrer</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ============================================ -->
    <!--      U13 : AVERTISSEMENT TIMEOUT SESSION     -->
    <!-- ============================================ -->
    <div id="session-warning" class="session-warning">
      <i class="fas fa-exclamation-triangle me-2"></i>
      <span>Session inactive — déconnexion dans <strong id="session-countdown">120</strong>s</span>
      <button class="btn btn-sm btn-dark btn-session" onclick="resetSessionTimer()">Rester connecté</button>
    </div>

    <!-- ============================================ -->
    <!--              INCLUSION DU JS                 -->
    <!-- ============================================ -->
    <!-- U11 : Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <?!= include('JS') ?>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
