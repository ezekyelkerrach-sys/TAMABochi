<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <?!= include('CSS') ?>
  </head>
  <body>

    <!-- ============================================ -->
    <!--                   LOADER                     -->
    <!-- ============================================ -->
    <div id="loader" class="loading">
      <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
    </div>

    <!-- ============================================ -->
    <!--                ECRAN LOGIN                   -->
    <!-- ============================================ -->
    <div id="login-screen">
      <div class="card shadow p-5" style="width: 450px;">
        <div class="text-center mb-5">
          <h2 class="fw-bold text-primary">TAMABochi</h2>
          <p class="text-muted">Utopia 56 Grande-Synthe</p>
        </div>
        <div class="mb-3">
          <label class="fw-bold small">Email</label>
          <input type="email" id="login-email" class="form-control form-control-lg">
        </div>
        <div class="mb-4">
          <label class="fw-bold small">Mot de passe</label>
          <input type="password" id="login-pass" class="form-control form-control-lg">
        </div>
        <button onclick="attemptLogin()" class="btn btn-primary w-100 py-3 fw-bold">Se connecter</button>
        <div id="login-error" class="text-danger mt-3 text-center small"></div>
      </div>
    </div>

    <!-- ============================================ -->
    <!--              CONTENU APPLICATION             -->
    <!-- ============================================ -->
    <div id="app-content" class="container-fluid" style="display:none !important;">
      <div class="row">

        <!-- ========== SIDEBAR ========== -->
        <div class="col-12 col-md-2 sidebar p-4">
          <h4 class="mb-4 text-center fw-bold">TAMABochi</h4>
          <div id="user-display" class="mb-4 text-center text-light small fw-bold bg-white bg-opacity-10 p-2 rounded"></div>
          <ul class="nav flex-column">
            <li class="nav-item"><a class="nav-link active" onclick="navigate('dashboard')"><i class="fas fa-home me-3"></i>Tableau de bord</a></li>
            <li class="nav-item"><a class="nav-link" onclick="navigate('suivi')"><i class="fas fa-search me-3"></i>Suivi & Recherche</a></li>
            <li class="nav-item"><a class="nav-link" onclick="navigate('enregistrement')"><i class="fas fa-user-plus me-3"></i>Enregistrement</a></li>
            <li class="nav-item"><a class="nav-link" onclick="navigate('plaidoyer')"><i class="fas fa-chart-pie me-3"></i>Plaidoyer</a></li>
            <!-- U7 : Badge compteur rappels en retard -->
            <li class="nav-item"><a class="nav-link" onclick="navigate('rappels')"><i class="fas fa-bell me-3"></i>Rappels<span id="sidebar-rappel-badge" class="nav-badge-count d-none">0</span></a></li>
            <hr class="my-4 border-light">
            <li class="nav-item"><a class="nav-link text-danger" onclick="logout()"><i class="fas fa-sign-out-alt me-3"></i>Déconnexion</a></li>
          </ul>
        </div>

        <!-- ========== CONTENU PRINCIPAL ========== -->
        <div class="col-12 col-md-10 p-5" style="height: 100vh; overflow-y: auto;">
          
          <!-- ============================================ -->
          <!--              VUE DASHBOARD                   -->
          <!-- ============================================ -->
          <div id="view-dashboard" class="content-view">
            <h2 class="fw-bold mb-4">Tableau de bord <small class="text-muted fs-6 ms-2">Aujourd'hui</small></h2>
            
            <!-- U3 : Raccourcis rapides -->
            <div class="row g-3 mb-4">
              <div class="col-md-3">
                <div class="quick-action-btn" onclick="navigate('enregistrement')">
                  <i class="fas fa-user-plus text-primary"></i>
                  <span>Nouveau Jeune</span>
                </div>
              </div>
              <div class="col-md-3">
                <div class="quick-action-btn" onclick="navigate('suivi')">
                  <i class="fas fa-search text-info"></i>
                  <span>Chercher un Jeune</span>
                </div>
              </div>
              <div class="col-md-3">
                <div class="quick-action-btn" onclick="navigate('suivi'); setTimeout(function(){ openEvictionModal(); }, 300);">
                  <i class="fas fa-house-chimney-crack text-danger"></i>
                  <span>Déclarer Éviction</span>
                </div>
              </div>
              <div class="col-md-3">
                <div class="quick-action-btn" onclick="navigate('plaidoyer')">
                  <i class="fas fa-chart-pie text-warning"></i>
                  <span>Voir les Stats</span>
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-md-5">
                <div class="card p-4 h-100">
                  <h5 class="fw-bold mb-3"><i class="fas fa-chart-line me-2 text-primary"></i>Activité du mois</h5>
                  <div class="row g-3">
                     <div class="col-6"><div class="dash-mini-card text-center"><div class="fs-2 fw-bold text-primary" id="dash-nouveaux">-</div><small class="text-muted">Nouveaux</small></div></div>
                     <div class="col-6"><div class="dash-mini-card text-center"><div class="fs-2 fw-bold text-dark" id="dash-actifs">-</div><small class="text-muted">Actifs (Stock)</small></div></div>
                     <div class="col-6"><div class="dash-mini-card text-center"><div class="fs-2 fw-bold text-info" id="dash-demandes">-</div><small class="text-muted">Demandes MAB</small></div></div>
                     <div class="col-6"><div class="dash-mini-card text-center"><div class="fs-2 fw-bold text-danger" id="dash-evictions">-</div><small class="text-muted">Évictions</small></div></div>
                  </div>
                  <div class="mt-3 text-center">
                    <button class="btn btn-sm btn-outline-primary w-100" onclick="navigate('plaidoyer')">Voir toutes les stats</button>
                  </div>
                </div>
              </div>
              <div class="col-md-7">
                <div class="card p-4 h-100">
                  <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="fw-bold m-0"><i class="fas fa-bell me-2 text-warning"></i>A faire</h5>
                    <button class="btn btn-sm btn-light" onclick="loadDashboard()">Actualiser</button>
                  </div>
                  <div id="dash-rappels-list" style="overflow-y:auto; max-height:400px;"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- ============================================ -->
          <!--           VUE SUIVI & RECHERCHE              -->
          <!-- ============================================ -->
          <div id="view-suivi" class="content-view d-none">
            <h2 class="fw-bold mb-4"><i class="fas fa-users text-primary me-2"></i>Suivi & Recherche</h2>
            
            <!-- Barre de recherche -->
            <div class="card p-4 mb-3">
              <div class="input-group input-group-lg">
                <input type="text" class="form-control border-0 bg-light" id="search-input" placeholder="Rechercher par Nom, Tel ou Lieu de vie...">
                <button class="btn btn-primary px-4" type="button" onclick="lancerRecherche()"><i class="fas fa-search"></i></button>
              </div>
              <!-- C12 / M5 : Boutons Tous les actifs + Tous les jeunes -->
              <div class="mt-2 d-flex gap-2 flex-wrap">
                <button class="btn btn-sm btn-outline-dark" onclick="afficherTousActifs()"><i class="fas fa-users me-1"></i> Tous les actifs</button>
                <button class="btn btn-sm btn-outline-secondary" onclick="afficherTousJeunes()"><i class="fas fa-database me-1"></i> Tous les jeunes</button>
                <!-- C6 : Bouton Éviction rapide -->
                <button class="btn btn-sm btn-eviction" onclick="openEvictionModal()"><i class="fas fa-house-chimney-crack me-1"></i> Éviction par lieu</button>
              </div>
            </div>

            <!-- C11 : Barre de filtres avancés (M6 : custom dropdowns) -->
            <div class="filter-bar card p-3 mb-3">
              <div class="row g-2 align-items-end">
                <div class="col-md-3">
                  <label class="form-label">Statut Présence</label>
                  <div id="filter-presence" class="custom-dropdown" data-config="STATUT_PRESENCE" data-mode="single" data-placeholder="Tous"></div>
                </div>
                <div class="col-md-3">
                  <label class="form-label">Statut MAB</label>
                  <div id="filter-mab" class="custom-dropdown" data-config="STATUTS_MAB" data-mode="single" data-placeholder="Tous"></div>
                </div>
                <div class="col-md-3">
                  <label class="form-label">Vulnérabilité</label>
                  <div id="filter-vuln" class="custom-dropdown" data-config="VULNERABILITES_TAGS" data-mode="single" data-placeholder="Toutes"></div>
                </div>
                <div class="col-md-2">
                  <label class="form-label">Lieu de Vie</label>
                  <div id="filter-lieu" class="custom-dropdown" data-config="LIEUX_VIE" data-mode="single" data-placeholder="Tous"></div>
                </div>
                <div class="col-md-1">
                  <button class="btn btn-sm btn-outline-secondary w-100 btn-filter-reset" onclick="resetFilters()"><i class="fas fa-times"></i></button>
                </div>
              </div>
            </div>

            <!-- U9 : Barre de tri + compteur résultats -->
            <div class="sort-bar d-none" id="sort-bar">
              <span class="result-count" id="result-count">0 résultats</span>
              <select class="form-select form-select-sm" id="sort-select" onchange="trierResultats()">
                <option value="nom-asc">Nom (A-Z)</option>
                <option value="nom-desc">Nom (Z-A)</option>
                <option value="age-asc">Âge (croissant)</option>
                <option value="age-desc">Âge (décroissant)</option>
                <option value="date-desc">Dernier contact (récent)</option>
                <option value="date-asc">Dernier contact (ancien)</option>
                <option value="lieu-asc">Lieu de vie (A-Z)</option>
              </select>
            </div>

            <div id="search-results-container" class="row g-3">
              <div class="col-12 text-center text-muted py-5">
                <i class="fas fa-inbox fa-3x mb-3"></i>
                <p>Les résultats s'afficheront ici.</p>
              </div>
            </div>
          </div>

          <!-- ============================================ -->
          <!--            VUE ENREGISTREMENT                -->
          <!-- ============================================ -->
          <div id="view-enregistrement" class="content-view d-none">
            <h2 class="fw-bold mb-4"><i class="fas fa-user-plus text-primary me-2"></i>Nouveau Jeune</h2>
            <div class="row">
              <div class="col-lg-9">
                <div class="card p-4">
                  <form id="form-creation" onsubmit="event.preventDefault(); return false;">
                    <input type="hidden" id="current-group-id" value="">
                    <!-- NOUVEAU : ID groupe lié via recherche (sans tel partagé) -->
                    <input type="hidden" id="linked-group-id" value="">
                    
                    <h5 class="text-primary fw-bold mb-3">Identité</h5>
                    <div class="row mb-3">
                      <div class="col-md-6">
                        <label class="form-label">Téléphone *</label>
                        <input type="text" class="form-control" id="new-tel" required onchange="verifierDoublon(this.value)">
                        <div id="alert-doublon" class="form-text text-danger fw-bold"></div>
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">Nom / Alias *</label>
                        <input type="text" class="form-control" id="new-nom" required>
                      </div>
                    </div>
                    <div class="row mb-3">
                      <div class="col-md-4">
                        <label class="form-label">Surnom</label>
                        <input type="text" class="form-control" id="new-surnom">
                      </div>
                      <div class="col-md-4">
                        <label class="form-label">Age</label>
                        <input type="number" class="form-control" id="new-age">
                      </div>
                      <div class="col-md-4">
                        <label class="form-label">Genre</label>
                        <div id="new-genre" class="custom-dropdown" data-config="GENRE" data-mode="single" data-placeholder="Sélectionner..."></div>
                      </div>
                    </div>
                    <div class="row mb-3">
                      <div class="col-md-4">
                        <label class="form-label fw-bold">Lieu de Vie (Actuel)</label>
                        <div id="new-lieuvie" class="custom-dropdown" data-config="LIEUX_VIE" data-mode="single" data-placeholder="Sélectionner..."></div>
                      </div>
                      <div class="col-md-4">
                        <label class="form-label">Nationalité</label>
                        <div id="new-nationalite" class="custom-dropdown" data-config="NATIONALITES" data-mode="single" data-placeholder="Sélectionner..."></div>
                      </div>
                      <div class="col-md-4">
                        <label class="form-label">Langue(s)</label>
                        <div id="new-langue" class="custom-dropdown" data-config="LANGUES" data-mode="multi" data-placeholder="Sélectionner..."></div>
                      </div>
                    </div>
                    
                    <!-- NOUVEAU : Liaison groupe sans téléphone partagé -->
                    <div class="mb-3 p-3 bg-light rounded border">
                      <div class="form-check form-switch mb-2">
                        <input class="form-check-input" type="checkbox" id="new-link-group-check" onchange="toggleLinkGroupSection()">
                        <label class="form-check-label fw-bold" for="new-link-group-check">
                          <i class="fas fa-link me-1"></i> Lier à un groupe avec téléphone différent
                        </label>
                      </div>
                      <div id="new-link-group-section" class="d-none mt-2">
                        <p class="text-muted small mb-2">Recherchez et sélectionnez les jeunes à lier à ce nouveau jeune (groupe commun, sans partager le même numéro).</p>
                        <button type="button" class="btn btn-sm btn-outline-info" onclick="openGroupLinkModal('enregistrement')">
                          <i class="fas fa-search me-1"></i> Rechercher des jeunes à lier
                        </button>
                        <div id="new-link-group-selected" class="mt-2 d-flex flex-wrap gap-1">
                          <!-- Badges des jeunes sélectionnés apparaîtront ici -->
                        </div>
                      </div>
                    </div>

                    <div class="mb-3">
                      <label class="form-label text-warning fw-bold"><i class="fas fa-sticky-note me-1"></i> Infos Importantes / Note Fixe</label>
                      <textarea class="form-control" id="new-notes-fixes" rows="1" placeholder="Ex: Lit l'allemand, Avec son frère majeur..."></textarea>
                    </div>

                    <div class="mb-3">
                      <label class="form-label text-info fw-bold">Labels / Autres Assos</label>
                      <div id="new-labels" class="custom-dropdown" data-config="LABELS_CONTACTS_AUTRES" data-mode="multi" data-placeholder="Sélectionner..."></div>
                    </div>

                    <hr>
                    <h5 class="text-primary fw-bold mb-3">Contexte de la Rencontre</h5>
                    <div class="alert alert-info py-2 small">
                      <i class="fas fa-info-circle"></i> Cet enregistrement créera automatiquement un événement <strong>"Rencontre"</strong>.
                    </div>
                    <div class="row mb-3">
                      <div class="col-md-6">
                        <label class="form-label">Date Rencontre</label>
                        <input type="date" class="form-control" id="new-date-rencontre">
                      </div>
                      <div class="col-md-6">
                        <label class="form-label fw-bold text-success">Type de Contact</label>
                        <div id="new-type-contact" class="custom-dropdown" data-config="TYPES_CONTACT" data-mode="multi" data-placeholder="Sélectionner..."></div>
                      </div>
                    </div>
                    <div class="mb-3">
                      <label class="form-label fw-bold">Vulnérabilités</label>
                      <div id="new-vulns" class="custom-dropdown" data-config="VULNERABILITES_TAGS" data-mode="multi" data-placeholder="Sélectionner..."></div>
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Notes</label>
                      <textarea class="form-control" id="new-details" rows="2"></textarea>
                    </div>

                    <!-- M2 : Suppression du bloc "Événements Antérieurs" -->
                    <!-- M3 : Enregistrer + Ajouter Autre conserve le tel et le groupId -->
                    <!-- M2 : Enregistrer & Terminer redirige vers la fiche -->
                    <div class="row g-2 mt-3">
                      <div class="col-md-6">
                        <button type="button" class="btn btn-outline-success w-100" onclick="soumettreNouveauJeune(null, true, false)"><i class="fas fa-user-plus me-1"></i> Enregistrer + Ajouter Autre</button>
                      </div>
                      <div class="col-md-6">
                        <button type="button" class="btn btn-success w-100" onclick="soumettreNouveauJeune(null, false, true)"><i class="fas fa-check me-1"></i> Enregistrer & Terminer</button>
                      </div>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>
          
          <!-- ============================================ -->
          <!--          VUE PLAIDOYER & STATS               -->
          <!-- ============================================ -->
          <div id="view-plaidoyer" class="content-view d-none">
            <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
              <h2 class="fw-bold"><i class="fas fa-chart-pie text-info me-2"></i>Statistiques & Plaidoyer</h2>
              <div class="d-flex gap-2">
                <!-- NOUVEAU : Bouton Gérer Favoris (remplace Export CSV) -->
                <button class="btn btn-outline-warning" onclick="openManageFavorisModal()"><i class="fas fa-star me-2"></i> Gérer Favoris</button>
                <button class="btn btn-dark" onclick="copyStatsSummary()"><i class="fas fa-copy me-2"></i> Copier Récapitulatif</button>
              </div>
            </div>
            
            <div class="card p-4 mb-4">
              <h5 class="card-title fw-bold mb-3">Période d'analyse</h5>
              <div class="row g-3 align-items-end">
                <div class="col-md-4">
                  <label class="form-label">Date Début</label>
                  <input type="date" class="form-control" id="stats-start">
                </div>
                <div class="col-md-4">
                  <label class="form-label">Date Fin</label>
                  <input type="date" class="form-control" id="stats-end">
                </div>
                <div class="col-md-4">
                  <button class="btn btn-info text-white w-100" onclick="loadStats()">Calculer les statistiques</button>
                </div>
              </div>
            </div>

            <!-- ====== NOUVEAU : RESULTATS STATS DETAILLES ====== -->
            <div id="stats-results" class="d-none">

              <!-- CARTE PRESENCE : 4 sous-cartes -->
              <div class="card p-4 mb-4 stats-presence-card">
                <h5 class="fw-bold mb-3"><i class="fas fa-users me-2 text-primary"></i>Population</h5>
                <div class="row g-3">
                  <div class="col-md-3"><div class="card stat-card stat-sub-card"><div class="stat-num text-primary" id="stat-presents">-</div><div class="stat-label">Présents</div></div></div>
                  <div class="col-md-3"><div class="card stat-card stat-sub-card"><div class="stat-num text-warning" id="stat-m15">-</div><div class="stat-label">Moins de 15 ans</div></div></div>
                  <div class="col-md-3"><div class="card stat-card stat-sub-card"><div class="stat-num text-danger" id="stat-filles">-</div><div class="stat-label">Filles</div></div></div>
                  <div class="col-md-3"><div class="card stat-card stat-sub-card"><div class="stat-num text-success" id="stat-nouveaux">-</div><div class="stat-label">Nouveaux (période)</div></div></div>
                </div>
              </div>

              <!-- FAVORIS : zone d'affichage des listes favorites (remplies dynamiquement par JS) -->
              <div id="stats-favoris-container" class="mb-4 d-none"></div>

              <!-- BOUTONS TOUT AFFICHER / TOUT MASQUER -->
              <div class="d-flex gap-2 mb-3 flex-wrap align-items-center">
                <button class="btn btn-sm btn-outline-dark" onclick="toggleAllStatsCards(true)"><i class="fas fa-eye me-1"></i> Tout afficher</button>
                <button class="btn btn-sm btn-outline-dark" onclick="toggleAllStatsCards(false)"><i class="fas fa-eye-slash me-1"></i> Tout masquer</button>
                <button class="btn btn-sm btn-outline-warning" onclick="openCustomizeFavoriModal()"><i class="fas fa-star me-1"></i> Créer un favori</button>
                <span class="text-muted small ms-2" id="stats-periode-label"></span>
              </div>

              <!-- CARTES LISTES BDD_CONFIG (chacune peut être show/hide) -->
              <div id="stats-lists-container">
                <!-- Les cartes sont générées dynamiquement par JS -->
              </div>

              <!-- CARTE ORPHELINS -->
              <div id="stats-orphelins-card" class="card p-4 mb-4 d-none border-warning">
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <h5 class="fw-bold text-warning mb-0"><i class="fas fa-ghost me-2"></i>Items orphelins</h5>
                  <button class="btn btn-sm btn-outline-secondary" onclick="toggleStatsCard('orphelins')"><i class="fas fa-eye-slash"></i></button>
                </div>
                <p class="text-muted small mb-3">Items présents dans les données mais absents de la configuration actuelle (BDD_CONFIG).</p>
                <div id="stats-orphelins-list" class="row g-2"></div>
              </div>

            </div>
          </div>
          
          <!-- ============================================ -->
          <!--               VUE RAPPELS                    -->
          <!-- ============================================ -->
          <div id="view-rappels" class="content-view d-none">
            <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
              <h2 class="fw-bold"><i class="fas fa-bell text-warning me-2"></i>Rappels & Suivi</h2>
              <div class="d-flex gap-2">
                <!-- C16 : Bouton nouveau rappel depuis vue Rappels -->
                <button class="btn btn-sm btn-danger" onclick="openRappelFromViewModal()"><i class="fas fa-plus me-1"></i> Nouveau Rappel</button>
                <button class="btn btn-sm btn-outline-secondary" onclick="loadRappels()"><i class="fas fa-sync"></i> Actualiser</button>
              </div>
            </div>

            <!-- NOUVEAU : Onglets rappels (En retard / À faire / Archivés) -->
            <ul class="nav nav-tabs mb-3" id="rappels-tabs" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="tab-enretard" data-bs-toggle="tab" data-bs-target="#pane-enretard" type="button" role="tab">
                  <i class="fas fa-exclamation-circle text-danger me-1"></i> En retard <span class="badge bg-danger ms-1" id="tab-enretard-count">0</span>
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-afaire" data-bs-toggle="tab" data-bs-target="#pane-afaire" type="button" role="tab">
                  <i class="fas fa-clock text-primary me-1"></i> À faire <span class="badge bg-primary ms-1" id="tab-afaire-count">0</span>
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-archives" data-bs-toggle="tab" data-bs-target="#pane-archives" type="button" role="tab">
                  <i class="fas fa-archive text-secondary me-1"></i> Archivés <span class="badge bg-secondary ms-1" id="tab-archives-count">0</span>
                </button>
              </li>
            </ul>
            <div class="tab-content" id="rappels-tab-content">
              <div class="tab-pane fade show active" id="pane-enretard" role="tabpanel">
                <div id="rappels-enretard-container" class="row g-3"></div>
              </div>
              <div class="tab-pane fade" id="pane-afaire" role="tabpanel">
                <div id="rappels-afaire-container" class="row g-3"></div>
              </div>
              <div class="tab-pane fade" id="pane-archives" role="tabpanel">
                <div id="rappels-archives-container" class="row g-3"></div>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- ============================================ -->
    <!--      BARRE FLOTTANTE ACTIONS (SELECTION)     -->
    <!-- ============================================ -->
    <div id="floating-bar" class="floating-action-bar">
      <span class="fw-bold"><span id="count-selected">0</span> jeunes sélectionnés</span>
      <button class="btn btn-warning btn-sm text-dark fw-bold" onclick="openMassEventModal()"><i class="fas fa-bolt me-1"></i> Appliquer un Événement</button>
      <button class="btn btn-sm btn-outline-light rounded-circle" onclick="clearSelection()"><i class="fas fa-times"></i></button>
    </div>

    <!-- ============================================ -->
    <!--         MODALE : FICHE JEUNE                 -->
    <!-- ============================================ -->
    <div class="modal fade" id="modalFicheJeune" tabindex="-1">
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <!-- U6 : Fil d'Ariane -->
            <div>
              <a id="breadcrumb-back" class="breadcrumb-back d-none" onclick="breadcrumbGoBack()"><i class="fas fa-arrow-left"></i> <span id="breadcrumb-text">Retour</span></a>
              <h5 class="modal-title fw-bold text-primary mb-0">Dossier Jeune</h5>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="row">
              <!-- COLONNE GAUCHE : INFOS -->
              <div class="col-md-4 border-end">
                <div class="text-center mb-4">
                  <div class="avatar bg-light rounded-circle d-inline-flex align-items-center justify-content-center mb-2" style="width: 80px; height: 80px;">
                    <i class="fas fa-user fa-3x text-secondary"></i>
                  </div>
                  <h3 id="fiche-nom" class="fw-bold mb-0"></h3>
                  <div class="text-muted small mb-2" id="fiche-surnom"></div>
                  <button class="btn btn-outline-primary btn-sm rounded-pill px-3" onclick="openEditProfile()"><i class="fas fa-pen me-2"></i>Modifier</button>
                </div>
                
                <div id="btn-see-group" class="d-grid mt-2 mb-3 d-none">
                  <button class="btn btn-sm btn-info text-white" onclick="showGroupMembers()"><i class="fas fa-users me-2"></i>Voir le groupe</button>
                </div>

                <!-- NOUVEAU : Bouton Lier à un autre jeune/groupe -->
                <div class="d-grid mb-3">
                  <button class="btn btn-sm btn-outline-info" onclick="openGroupLinkModal('fiche')"><i class="fas fa-link me-2"></i>Lier à un autre jeune / groupe</button>
                </div>

                <div class="p-3 bg-light rounded mb-3">
                  <div class="d-flex justify-content-between mb-2"><strong>Tel:</strong> <span id="fiche-tel"></span></div>
                  <div class="d-flex justify-content-between mb-2"><strong>Age:</strong> <span id="fiche-age"></span></div>
                  <div class="d-flex justify-content-between mb-2"><strong>Nat:</strong> <span id="fiche-nat"></span></div>
                  <div class="d-flex justify-content-between mb-2"><strong>Lieu:</strong> <span id="fiche-lieu"></span></div>
                  <!-- C9 : Date dernière distribution -->
                  <div class="d-flex justify-content-between mb-2"><strong>Dern. Contact:</strong> <span id="fiche-date-contact" class="small"></span></div>
                  <div class="d-flex justify-content-between mb-2"><strong>Dern. Rencontre:</strong> <span id="fiche-date-rencontre" class="small"></span></div>
                  <div class="d-flex justify-content-between"><strong>Dern. Distrib:</strong> <span id="fiche-date-distrib" class="small"></span></div>
                </div>
                
                <div class="mb-4">
                  <small class="text-uppercase text-muted fw-bold">Statuts</small>
                  <div class="mt-2 d-flex flex-column gap-2">
                    <span class="badge bg-primary text-start p-2" id="fiche-statut-mab-full"></span>
                    <span class="badge bg-secondary text-start p-2" id="fiche-statut-presence-full"></span>
                  </div>
                </div>
                
                <div class="alert alert-warning py-2 mb-3 small d-flex align-items-center">
                  <i class="fas fa-exclamation-circle me-2"></i>
                  <span id="fiche-notes-fixes" class="fw-bold"></span>
                </div>

                <div class="mb-3">
                  <small class="text-uppercase text-muted fw-bold">Vulnérabilités</small>
                  <div id="fiche-vulns" class="mt-2 d-flex flex-wrap gap-1"></div>
                </div>
                
                <div class="mb-3">
                  <small class="text-uppercase text-muted fw-bold">Labels / Autres Assos</small>
                  <div id="fiche-labels" class="mt-2 d-flex flex-wrap gap-1"></div>
                </div>

                <div class="d-grid mt-4 gap-2">
                  <button class="btn btn-outline-danger" onclick="openAddReminderModal()"><i class="fas fa-bell me-2"></i> Ajouter un Rappel</button>
                  <button class="btn btn-dark" onclick="generateReport()"><i class="fas fa-file-alt me-2"></i> Générer Rapport / IP</button>
                </div>
              </div>

              <!-- COLONNE DROITE : HISTORIQUE -->
              <div class="col-md-8">
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <h5 class="fw-bold m-0">Historique & Parcours</h5>
                  <button class="btn btn-warning text-dark fw-bold" onclick="openAddEventModal()"><i class="fas fa-plus-circle me-2"></i>Nouvel Événement</button>
                </div>
                
                <div class="form-check form-switch mb-3">
                  <input class="form-check-input" type="checkbox" id="show-tech-history" onchange="renderTimeline()">
                  <label class="form-check-label small text-muted" for="show-tech-history">Voir les modifications techniques</label>
                </div>

                <div id="fiche-timeline" class="bg-white p-3 rounded border" style="max-height: 500px; overflow-y: auto;"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- ============================================ -->
    <!--          MODALE : RAPPORT IP                 -->
    <!-- ============================================ -->
    <div class="modal fade" id="modalReport" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Rapport Généré (Information Préoccupante)</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <textarea id="report-text" class="form-control" rows="20" style="font-family: monospace; font-size: 0.85em;"></textarea>
          </div>
          <div class="modal-footer">
            <button class="btn btn-primary" onclick="copyReport()"><i class="fas fa-copy me-2"></i>Copier le texte</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ============================================ -->
    <!--       MODALE : MEMBRES DU GROUPE             -->
    <!-- ============================================ -->
    <div class="modal fade" id="modalGroupMembers" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Membres du Groupe</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body" id="group-members-list">Chargement...</div>
        </div>
      </div>
    </div>

    <!-- ============================================ -->
    <!--       MODALE : AJOUTER RAPPEL (FICHE)        -->
    <!-- ============================================ -->
    <div class="modal fade" id="modalAddReminder" tabindex="-1" style="z-index: 1070;">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Ajouter un Rappel</h5>
            <button type="button" class="btn-close" onclick="closeAddReminderModal()"></button>
          </div>
          <div class="modal-body">
            <form id="form-rappel">
              <div class="mb-3">
                <label class="form-label">Titre</label>
                <input type="text" class="form-control" id="rappel-titre" placeholder="Ex: Prendre des nouvelles">
              </div>
              <!-- M7 : Type de rappel -->
              <div class="mb-3">
                <label class="form-label">Type de rappel</label>
                <div id="rappel-type" class="custom-dropdown" data-config="TYPES_RAPPELS" data-mode="single" data-placeholder="Sélectionner..."></div>
              </div>
              <div class="mb-3">
                <label class="form-label">Date d'échéance</label>
                <input type="date" class="form-control" id="rappel-date">
              </div>
              <div class="mb-3">
                <label class="form-label">Détails</label>
                <textarea class="form-control" id="rappel-details" rows="2"></textarea>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-danger w-100" onclick="soumettreRappelManuel()">Créer le Rappel</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ============================================ -->
    <!--  C16 : MODALE : NOUVEAU RAPPEL (VUE RAPPELS) -->
    <!-- ============================================ -->
    <div class="modal fade" id="modalRappelFromView" tabindex="-1" style="z-index: 1070;">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-danger text-white">
            <h5 class="modal-title"><i class="fas fa-bell me-2"></i>Nouveau Rappel</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form id="form-rappel-from-view">
              <!-- Recherche du jeune -->
              <div class="mb-3">
                <label class="form-label fw-bold">Rechercher le jeune</label>
                <input type="text" class="form-control" id="rappel-view-search" placeholder="Nom, surnom ou téléphone..." oninput="searchJeuneForRappelView(this.value)">
                <input type="hidden" id="rappel-view-id-jeune" value="">
                <div id="rappel-view-search-results" class="rappel-search-results d-none"></div>
                <div id="rappel-view-selected" class="mt-2 d-none">
                  <span class="badge bg-primary p-2" id="rappel-view-selected-name"></span>
                  <button type="button" class="btn btn-sm btn-link text-danger" onclick="clearRappelViewSelection()"><i class="fas fa-times"></i></button>
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label">Titre</label>
                <input type="text" class="form-control" id="rappel-view-titre" placeholder="Ex: Prendre des nouvelles">
              </div>
              <!-- M7 : Type de rappel -->
              <div class="mb-3">
                <label class="form-label">Type de rappel</label>
                <div id="rappel-view-type" class="custom-dropdown" data-config="TYPES_RAPPELS" data-mode="single" data-placeholder="Sélectionner..."></div>
              </div>
              <div class="mb-3">
                <label class="form-label">Date d'échéance</label>
                <input type="date" class="form-control" id="rappel-view-date">
              </div>
              <div class="mb-3">
                <label class="form-label">Détails</label>
                <textarea class="form-control" id="rappel-view-details" rows="2"></textarea>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-danger w-100" onclick="soumettreRappelFromView()">Créer le Rappel</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ============================================ -->
    <!--       MODALE : MODIFIER RAPPEL               -->
    <!-- ============================================ -->
    <div class="modal fade" id="modalUpdateReminder" tabindex="-1" style="z-index: 1070;">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Modifier le Rappel</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form id="form-update-rappel">
              <input type="hidden" id="update-rappel-id">
              <div class="mb-3">
                <label class="form-label">Date d'échéance</label>
                <input type="date" class="form-control" id="update-rappel-date">
              </div>
              <div class="mb-3">
                <label class="form-label">Détails</label>
                <textarea class="form-control" id="update-rappel-details" rows="2"></textarea>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" onclick="soumettreUpdateRappel()">Enregistrer</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ============================================ -->
    <!--       MODALE : CLOTURER RAPPEL               -->
    <!-- ============================================ -->
    <div class="modal fade" id="modalCloseReminder" tabindex="-1" style="z-index: 1070;">
      <div class="modal-dialog modal-sm">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Clôturer le rappel</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body text-center">
            <p>Quel statut pour ce rappel ?</p>
            <input type="hidden" id="close-rappel-id">
            <div class="d-grid gap-2">
              <button class="btn btn-success" onclick="soumettreCloseRappel('Fait')"><i class="fas fa-check me-2"></i> Fait</button>
              <button class="btn btn-secondary" onclick="soumettreCloseRappel('Abandonné')"><i class="fas fa-times me-2"></i> Abandonné</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- ============================================ -->
    <!--       MODALE : MODIFIER PROFIL               -->
    <!-- ============================================ -->
    <div class="modal fade" id="modalEditProfile" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Modifier Informations</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form id="form-edit-profile">
              <div class="mb-3">
                <label class="form-label">Nom / Alias</label>
                <input type="text" class="form-control" id="edit-nom">
              </div>
              <div class="mb-3">
                <label class="form-label">Surnom</label>
                <input type="text" class="form-control" id="edit-surnom">
              </div>
              <div class="mb-3">
                <label class="form-label">Téléphone</label>
                <input type="text" class="form-control" id="edit-tel">
              </div>
              <div class="row mb-3">
                <div class="col-6">
                  <label class="form-label">Age</label>
                  <input type="number" class="form-control" id="edit-age">
                </div>
                <div class="col-6">
                  <label class="form-label">Lieu de vie</label>
                  <div id="edit-lieu" class="custom-dropdown" data-config="LIEUX_VIE" data-mode="single" data-placeholder="Sélectionner..."></div>
                </div>
              </div>
              <hr>
              <div class="mb-3">
                <label class="form-label fw-bold">Statut MAB</label>
                <div id="edit-statut-mab" class="custom-dropdown" data-config="STATUTS_MAB" data-mode="single" data-placeholder="Sélectionner..."></div>
              </div>
              <div class="mb-3">
                <label class="form-label fw-bold">Statut Présence</label>
                <div id="edit-statut-pres" class="custom-dropdown" data-config="STATUT_PRESENCE" data-mode="single" data-placeholder="Sélectionner..."></div>
              </div>
              <hr>
              <div class="mb-3">
                <label class="form-label text-warning fw-bold">Note Fixe</label>
                <textarea class="form-control" id="edit-notes-fixes" rows="2"></textarea>
              </div>
              <div class="mb-3">
                <label class="form-label text-info fw-bold">Labels / Autres Assos</label>
                <div id="edit-labels" class="custom-dropdown" data-config="LABELS_CONTACTS_AUTRES" data-mode="multi" data-placeholder="Sélectionner..."></div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button class="btn btn-primary" onclick="saveEditProfile()">Enregistrer</button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- ============================================ -->
    <!--       MODALE : MODIFIER EVENEMENT            -->
    <!-- ============================================ -->
    <div class="modal fade" id="modalEditEvent" tabindex="-1" style="z-index: 1080;">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-warning text-dark">
            <h5 class="modal-title">Modifier l'événement</h5>
            <button type="button" class="btn-close" onclick="closeEditEventModal()"></button>
          </div>
          <div class="modal-body">
            <form id="form-edit-event">
              <input type="hidden" id="edit-event-id">
              <div class="mb-3">
                <label class="form-label">Date</label>
                <input type="date" class="form-control" id="edit-event-date">
              </div>
              <div class="mb-3">
                <label class="form-label">Type</label>
                <div id="edit-event-type" class="custom-dropdown" data-config="TYPES_EVENEMENTS" data-mode="single" data-placeholder="Sélectionner..."></div>
              </div>
              <div class="mb-3">
                <label class="form-label">Détails</label>
                <textarea class="form-control" id="edit-event-details" rows="3"></textarea>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button class="btn btn-primary" onclick="saveEditedEvent()">Enregistrer</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ============================================ -->
    <!--       MODALE : NOUVEL EVENEMENT              -->
    <!-- ============================================ -->
    <div class="modal fade" id="modalAddEvent" tabindex="-1" style="z-index: 1060;">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-warning text-dark">
            <h5 class="modal-title fw-bold" id="modal-event-title">Nouvel Événement</h5>
            <button type="button" class="btn-close" onclick="closeAddEventModal()"></button>
          </div>
          <div class="modal-body">
            <form id="form-event">
              <input type="hidden" id="event-id-jeune">
              <div class="mb-3">
                <label class="form-label fw-bold">Type d'événement</label>
                <div id="event-type" class="custom-dropdown" data-config="TYPES_EVENEMENTS" data-mode="single" data-placeholder="Sélectionner..." data-onchange="updateFormFields"></div>
              </div>
              <div class="row mb-3">
                <div class="col-6">
                  <label class="form-label">Date</label>
                  <input type="date" class="form-control" id="event-date">
                </div>
                <div class="col-6 d-none" id="group-event-lieuevent">
                  <label class="form-label">Lieu Événement</label>
                  <div id="event-lieuevent" class="custom-dropdown" data-config="LIEUX_EVENTS" data-mode="single" data-placeholder="Sélectionner..."></div>
                </div>
              </div>
              <div class="mb-3 d-none" id="group-event-contact">
                <label class="form-label">Type Contact</label>
                <div id="event-contact" class="custom-dropdown" data-config="TYPES_CONTACT" data-mode="multi" data-placeholder="Sélectionner..."></div>
              </div>
              <div class="mb-3 d-none p-3 bg-light rounded border" id="group-event-lieuvie">
                <label class="form-label text-primary fw-bold">Mise à jour Lieu de Vie</label>
                <div id="event-lieuvie" class="custom-dropdown" data-config="LIEUX_VIE" data-mode="single" data-placeholder="Sélectionner..."></div>
              </div>
              <div class="mb-3 d-none p-3 bg-light rounded border" id="group-event-mab">
                <label class="form-label text-primary fw-bold">Nouveau Statut MAB</label>
                <div id="event-statut-mab" class="custom-dropdown" data-config="STATUTS_MAB" data-mode="single" data-placeholder="Sélectionner..."></div>
              </div>
              <div class="mb-3 d-none p-3 bg-light rounded border" id="group-event-presence">
                <label class="form-label text-primary fw-bold">Nouveau Statut Présence</label>
                <div id="event-statut-presence" class="custom-dropdown" data-config="STATUT_PRESENCE" data-mode="single" data-placeholder="Sélectionner..."></div>
              </div>
              <!-- M1 : Renommé de "Motif Refus" à "Motif Statut MAB" -->
              <div class="mb-3 d-none" id="group-event-refus">
                <label class="form-label text-danger fw-bold">Motif Statut MAB</label>
                <div id="event-motif-statut-mab" class="custom-dropdown" data-config="MOTIF_STATUT_MAB" data-mode="multi" data-placeholder="Sélectionner..."></div>
              </div>
              <div class="mb-3 d-none p-3 bg-light rounded border" id="group-event-materiel">
                <label class="form-label fw-bold">Matériel Distribué</label>
                <div id="event-materiel" class="custom-dropdown" data-config="MATERIEL" data-mode="multi" data-placeholder="Sélectionner..."></div>
              </div>
              <div class="mb-3 d-none p-3 bg-light rounded border" id="group-event-vulns">
                <label class="form-label text-primary fw-bold">Ajouter Vulnérabilité</label>
                <div id="event-vulns" class="custom-dropdown" data-config="VULNERABILITES_TAGS" data-mode="multi" data-placeholder="Sélectionner..."></div>
              </div>
              <div class="mb-3 d-none" id="group-event-note">
                <label class="form-label">Note / Détails</label>
                <textarea class="form-control" id="event-note" rows="2"></textarea>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary w-100" onclick="soumettreEvent()">Valider</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ============================================ -->
    <!--       MODALE : CONFLIT DOUBLON               -->
    <!-- ============================================ -->
    <div class="modal fade" id="modalConflit" tabindex="-1" data-bs-backdrop="static">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-warning text-dark">
            <h5 class="modal-title">Numéro existant</h5>
          </div>
          <div class="modal-body">
            <p>Déjà attribué à : <strong id="conflit-noms"></strong>.</p>
            <div class="d-grid gap-2">
              <button class="btn btn-primary" onclick="resoudreConflit('JOIN_GROUP')">Même groupe (Fratrie...)</button>
              <button class="btn btn-danger" onclick="resoudreConflit('NEW_OWNER')">Nouveau propriétaire (Rotation SIM)</button>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ============================================ -->
    <!--  C6 : MODALE : EVICTION PAR LIEU DE VIE      -->
    <!-- ============================================ -->
    <div class="modal fade" id="modalEviction" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-danger text-white">
            <h5 class="modal-title"><i class="fas fa-house-chimney-crack me-2"></i>Éviction rapide par Lieu de Vie</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <p class="text-muted small">Sélectionnez un lieu de vie. Tous les jeunes actifs sur ce lieu seront ajoutés au panier, et le formulaire d'événement sera pré-rempli sur "Éviction".</p>
            <div class="mb-3">
              <label class="form-label fw-bold">Lieu de vie concerné</label>
              <div id="eviction-lieu" class="custom-dropdown" data-config="LIEUX_VIE" data-mode="single" data-placeholder="Sélectionner..." data-onchange="onEvictionLieuChange"></div>
            </div>
            <div id="eviction-preview" class="d-none">
              <div class="alert alert-info py-2 small">
                <i class="fas fa-users me-1"></i> <strong id="eviction-count">0</strong> jeune(s) trouvé(s) sur ce lieu.
              </div>
              <div id="eviction-list" style="max-height: 200px; overflow-y: auto;"></div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Annuler</button>
            <button type="button" class="btn btn-danger" id="btn-confirm-eviction" onclick="confirmEviction()" disabled><i class="fas fa-check me-2"></i>Confirmer & Ouvrir Événement</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ============================================ -->
    <!--  NOUVEAU : MODALE COMMENTAIRE RAPPEL         -->
    <!-- ============================================ -->
    <div class="modal fade" id="modalAddComment" tabindex="-1" style="z-index: 1070;">
      <div class="modal-dialog modal-sm">
        <div class="modal-content">
          <div class="modal-header bg-info text-white">
            <h5 class="modal-title"><i class="fas fa-comment me-2"></i>Ajouter un commentaire</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="comment-rappel-id">
            <div class="mb-3">
              <label class="form-label">Commentaire</label>
              <textarea class="form-control" id="comment-text" rows="3" placeholder="Ex: Appelé, pas de réponse..."></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-info text-white w-100" onclick="soumettreCommentRappel()"><i class="fas fa-check me-2"></i>Ajouter</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ============================================ -->
    <!--  NOUVEAU : MODALE GERER FAVORIS (STATS)      -->
    <!-- ============================================ -->
    <div class="modal fade" id="modalManageFavoris" tabindex="-1" style="z-index: 1070;">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-warning text-dark">
            <h5 class="modal-title"><i class="fas fa-star me-2"></i>Gérer les Favoris</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <p class="text-muted small">Vos listes favorites apparaissent en priorité après le calcul des statistiques. Vous pouvez les modifier ou les supprimer ici.</p>
            <div id="manage-favoris-list">
              <p class="text-muted text-center py-3">Aucun favori créé.</p>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-warning" onclick="closeManageFavorisAndCreate()"><i class="fas fa-plus me-1"></i> Créer un nouveau favori</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ============================================ -->
    <!--  NOUVEAU : MODALE CREER/EDITER FAVORI        -->
    <!-- ============================================ -->
    <div class="modal fade" id="modalCustomizeFavori" tabindex="-1" style="z-index: 1080;">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header bg-warning text-dark">
            <h5 class="modal-title"><i class="fas fa-star me-2"></i>Créer une liste favorite</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="favori-edit-index" value="-1">
            <div class="mb-3">
              <label class="form-label fw-bold">Nom de la liste</label>
              <input type="text" class="form-control" id="favori-name" placeholder="Ex: Chiffres clés évictions, Vulnérabilités prioritaires...">
            </div>
            <p class="text-muted small">Cochez les items que vous souhaitez inclure dans cette liste favorite. Tous les items de BDD_CONFIG sont disponibles, y compris ceux à 0. Les items sélectionnés avec un compte de 0 apparaîtront grisés en bas de la liste.</p>
            <div id="favori-items-selector" class="favori-selector">
              <!-- Rempli dynamiquement par JS avec les checkboxes regroupées par catégorie -->
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-warning" onclick="saveFavori()"><i class="fas fa-save me-1"></i> Enregistrer</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ============================================ -->
    <!--  NOUVEAU : MODALE LIAISON GROUPE             -->
    <!-- ============================================ -->
    <div class="modal fade" id="modalGroupLink" tabindex="-1" style="z-index: 1090;">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header bg-info text-white">
            <h5 class="modal-title"><i class="fas fa-link me-2"></i>Lier à un groupe</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="group-link-context" value="">
            <p class="text-muted small mb-3">Recherchez des jeunes par nom, surnom ou téléphone, puis sélectionnez ceux que vous souhaitez lier au même groupe.</p>
            
            <div class="mb-3">
              <label class="form-label fw-bold">Rechercher</label>
              <div class="input-group">
                <input type="text" class="form-control" id="group-link-search" placeholder="Nom, surnom ou téléphone..." oninput="searchJeunesForGroupLinkUI(this.value)">
                <button class="btn btn-outline-info" type="button" onclick="searchJeunesForGroupLinkUI(document.getElementById('group-link-search').value)"><i class="fas fa-search"></i></button>
              </div>
            </div>

            <!-- Résultats de recherche -->
            <div id="group-link-results" class="mb-3" style="max-height: 250px; overflow-y: auto;">
              <p class="text-muted text-center small py-3">Les résultats apparaîtront ici.</p>
            </div>

            <!-- Jeunes sélectionnés -->
            <div class="border-top pt-3">
              <label class="form-label fw-bold"><i class="fas fa-check-circle text-success me-1"></i> Jeunes sélectionnés pour le groupe</label>
              <div id="group-link-selected" class="d-flex flex-wrap gap-2">
                <span class="text-muted small">Aucun jeune sélectionné.</span>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Annuler</button>
            <button type="button" class="btn btn-info text-white" onclick="confirmGroupLink()"><i class="fas fa-check me-2"></i>Confirmer la liaison</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ============================================ -->
    <!--      U13 : AVERTISSEMENT TIMEOUT SESSION     -->
    <!-- ============================================ -->
    <div id="session-warning" class="session-warning">
      <i class="fas fa-exclamation-triangle me-2"></i>
      <span>Session inactive — déconnexion dans <strong id="session-countdown">120</strong>s</span>
      <button class="btn btn-sm btn-dark btn-session" onclick="resetSessionTimer()">Rester connecté</button>
    </div>

    <!-- ============================================ -->
    <!--              INCLUSION DU JS                 -->
    <!-- ============================================ -->
    <!-- U11 : Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <?!= include('JS') ?>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
